name: Auto Lint & Fix

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 3ì‹œ (KST 12ì‹œ)ì— ì‹¤í–‰
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'PR ìƒì„± ì—¬ë¶€ (true/false)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      target_branch:
        description: 'ëŒ€ìƒ ë¸Œëžœì¹˜'
        required: false
        default: 'main'
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-lint-fix:
    name: Lint and Auto-fix
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.target_branch || 'main' }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint check (before fix)
        id: lint_check
        run: |
          echo "## ðŸ” Lint ì²´í¬ ê²°ê³¼" > lint-report.md
          echo "" >> lint-report.md

          # ESLint ì‹¤í–‰í•˜ê³  ê²°ê³¼ ì €ìž¥
          if pnpm run lint 2>&1 | tee lint-output.txt; then
            echo "âœ… Lint ì—ëŸ¬ ì—†ìŒ" >> lint-report.md
            echo "has_errors=false" >> $GITHUB_OUTPUT
            exit 0
          else
            # ì—ëŸ¬ ê°œìˆ˜ ì¶”ì¶œ
            error_count=$(grep -c "error" lint-output.txt || echo "0")
            warning_count=$(grep -c "warning" lint-output.txt || echo "0")

            echo "âŒ Lint ë¬¸ì œ ë°œê²¬:" >> lint-report.md
            echo "- ì—ëŸ¬: $error_count" >> lint-report.md
            echo "- ê²½ê³ : $warning_count" >> lint-report.md
            echo "" >> lint-report.md
            echo "\`\`\`" >> lint-report.md
            cat lint-output.txt >> lint-report.md
            echo "\`\`\`" >> lint-report.md

            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "error_count=$error_count" >> $GITHUB_OUTPUT
            echo "warning_count=$warning_count" >> $GITHUB_OUTPUT
          fi

      - name: Auto-fix with ESLint
        if: steps.lint_check.outputs.has_errors == 'true'
        id: eslint_fix
        run: |
          echo "ðŸ”§ ESLint ìžë™ ìˆ˜ì • ì‹œë„..."

          # ESLint --fix ì‹¤í–‰
          pnpm run lint:fix || true

          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if [[ -n $(git status --porcelain) ]]; then
            echo "fixed_files=true" >> $GITHUB_OUTPUT
            echo "âœ… ì¼ë¶€ íŒŒì¼ì´ ìžë™ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤" >> lint-report.md
            echo "" >> lint-report.md
            echo "### ìˆ˜ì •ëœ íŒŒì¼:" >> lint-report.md
            git status --short >> lint-report.md
          else
            echo "fixed_files=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ìžë™ ìˆ˜ì • ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤" >> lint-report.md
          fi

      - name: Run ESLint check (after fix)
        if: steps.eslint_fix.outputs.fixed_files == 'true'
        id: lint_recheck
        run: |
          echo "" >> lint-report.md
          echo "## ðŸ” ìž¬ê²€ì‚¬ ê²°ê³¼" >> lint-report.md
          echo "" >> lint-report.md

          if pnpm run lint 2>&1 | tee lint-recheck.txt; then
            echo "âœ… ëª¨ë“  Lint ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!" >> lint-report.md
            echo "all_fixed=true" >> $GITHUB_OUTPUT
          else
            remaining_errors=$(grep -c "error" lint-recheck.txt || echo "0")
            remaining_warnings=$(grep -c "warning" lint-recheck.txt || echo "0")

            echo "âš ï¸ ì—¬ì „ížˆ ë‚¨ì•„ìžˆëŠ” ë¬¸ì œ:" >> lint-report.md
            echo "- ì—ëŸ¬: $remaining_errors" >> lint-report.md
            echo "- ê²½ê³ : $remaining_warnings" >> lint-report.md
            echo "" >> lint-report.md
            echo "\`\`\`" >> lint-report.md
            head -50 lint-recheck.txt >> lint-report.md
            echo "\`\`\`" >> lint-report.md

            echo "all_fixed=false" >> $GITHUB_OUTPUT
            echo "remaining_errors=$remaining_errors" >> $GITHUB_OUTPUT
            echo "remaining_warnings=$remaining_warnings" >> $GITHUB_OUTPUT
          fi

      - name: Create fix branch and commit
        if: steps.eslint_fix.outputs.fixed_files == 'true'
        id: create_branch
        run: |
          # ë¸Œëžœì¹˜ ì´ë¦„ ìƒì„±
          BRANCH_NAME="auto-lint-fix/$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # ìƒˆ ë¸Œëžœì¹˜ ìƒì„± ë° ì²´í¬ì•„ì›ƒ
          git checkout -b "$BRANCH_NAME"

          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git add -A
          git commit -m "fix: ESLint ìžë™ ìˆ˜ì • ì ìš©

ìžë™ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥í•œ Lint ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

- ìˆ˜ì • ì „ ì—ëŸ¬: ${{ steps.lint_check.outputs.error_count }}ê°œ
- ìˆ˜ì • ì „ ê²½ê³ : ${{ steps.lint_check.outputs.warning_count }}ê°œ

ðŸ¤– ìžë™ ìƒì„±ëœ ì»¤ë°‹ìž…ë‹ˆë‹¤.

[skip ci]" || echo "No changes to commit"

          # í‘¸ì‹œ
          git push origin "$BRANCH_NAME"

          echo "âœ… ë³€ê²½ì‚¬í•­ì´ ë¸Œëžœì¹˜ $BRANCH_NAME ì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤" >> lint-report.md

      - name: Create Pull Request
        if: steps.eslint_fix.outputs.fixed_files == 'true' && (inputs.create_pr == 'true' || github.event_name == 'schedule')
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const branchName = '${{ steps.create_branch.outputs.branch_name }}';
            const baseBranch = '${{ inputs.target_branch || 'main' }}';

            let reportContent = '';
            if (fs.existsSync('lint-report.md')) {
              reportContent = fs.readFileSync('lint-report.md', 'utf8');
            }

            const allFixed = '${{ steps.lint_recheck.outputs.all_fixed }}' === 'true';
            const remainingErrors = '${{ steps.lint_recheck.outputs.remaining_errors }}' || '0';

            const title = allFixed
              ? 'ðŸ”§ ìžë™ Lint ìˆ˜ì • ì ìš©'
              : `âš ï¸ ìžë™ Lint ìˆ˜ì • ì ìš© (${remainingErrors}ê°œ ìˆ˜ë™ ìˆ˜ì • í•„ìš”)`;

            const body = `# ðŸ”§ ìžë™ Lint ìˆ˜ì •

**ì‹¤í–‰ ì¼ì‹œ:** ${new Date().toISOString()}
**ì›Œí¬í”Œë¡œìš°:** [Run #${{ github.run_id }}](../actions/runs/${{ github.run_id }})

---

${reportContent}

---

## ðŸ“ ê²€í†  ì‚¬í•­

${allFixed
  ? 'âœ… ëª¨ë“  Lint ë¬¸ì œê°€ ìžë™ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì„ ê²€í†  í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.'
  : `âš ï¸ ì¼ë¶€ ë¬¸ì œëŠ” ìžë™ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚¨ì€ ${remainingErrors}ê°œì˜ ì—ëŸ¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.`
}

## ðŸ¤– ìžë™ ìƒì„±ëœ PR

ì´ PRì€ ìžë™ Lint ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
- ESLintì˜ \`--fix\` ì˜µì…˜ìœ¼ë¡œ ìžë™ ìˆ˜ì • ê°€ëŠ¥í•œ í•­ëª©ë§Œ í¬í•¨
- ì½”ë“œ ë¡œì§ ë³€ê²½ ì—†ìŒ (í¬ë§·íŒ… ë° ìŠ¤íƒ€ì¼ ìˆ˜ì •ë§Œ)
- ë³€ê²½ì‚¬í•­ì„ ê²€í†  í›„ ì•ˆì „í•˜ê²Œ ë¨¸ì§€ ê°€ëŠ¥

**ì£¼ì˜:** ìˆ˜ë™ ìˆ˜ì •ì´ í•„ìš”í•œ í•­ëª©ì€ ë³„ë„ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              head: branchName,
              base: baseBranch,
              body: body
            });

            console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);

            // ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['automated', 'lint', 'auto-fix']
            });

            // ë‚¨ì€ ì—ëŸ¬ê°€ ìžˆìœ¼ë©´ review-needed ë¼ë²¨ ì¶”ê°€
            if (!allFixed) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['review-needed']
              });
            }

      - name: Create issue for unfixable errors
        if: steps.lint_recheck.outputs.all_fixed == 'false' && steps.lint_recheck.outputs.remaining_errors > 0
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const remainingErrors = '${{ steps.lint_recheck.outputs.remaining_errors }}';
            const remainingWarnings = '${{ steps.lint_recheck.outputs.remaining_warnings }}';

            let lintOutput = '';
            if (fs.existsSync('lint-recheck.txt')) {
              lintOutput = fs.readFileSync('lint-recheck.txt', 'utf8');
              // ë„ˆë¬´ ê¸¸ë©´ ìž˜ë¼ë‚´ê¸°
              if (lintOutput.length > 10000) {
                lintOutput = lintOutput.substring(0, 10000) + '\n\n... (ë‚´ìš©ì´ ìž˜ë ¸ìŠµë‹ˆë‹¤. ì „ì²´ ë‚´ìš©ì€ ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”)';
              }
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”§ ìˆ˜ë™ ìˆ˜ì • í•„ìš”: ${remainingErrors}ê°œì˜ Lint ì—ëŸ¬`,
              labels: ['lint', 'manual-fix-required', 'priority-high'],
              body: `# ðŸ”§ Lint ìˆ˜ë™ ìˆ˜ì • í•„ìš”

**ë°œê²¬ ì¼ì‹œ:** ${new Date().toISOString()}
**ì›Œí¬í”Œë¡œìš°:** [Run #${{ github.run_id }}](../actions/runs/${{ github.run_id }})

## ðŸ“Š ë¬¸ì œ ìš”ì•½

- ðŸš¨ ìžë™ ìˆ˜ì • ë¶ˆê°€ ì—ëŸ¬: **${remainingErrors}ê°œ**
- âš ï¸ ê²½ê³ : **${remainingWarnings}ê°œ**

## ðŸ” ìƒì„¸ ë‚´ìš©

\`\`\`
${lintOutput}
\`\`\`

## ðŸ“ ì¡°ì¹˜ í•„ìš”

ë‹¤ìŒ ì—ëŸ¬ë“¤ì€ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤:

1. ì—ëŸ¬ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì½”ë“œ ìˆ˜ì •
2. ë¡œì»¬ì—ì„œ \`pnpm run lint:fix\` ì‹¤í–‰
3. ë‚¨ì€ ì—ëŸ¬ ìˆ˜ë™ ìˆ˜ì •
4. \`pnpm run lint\`ë¡œ ê²€ì¦
5. ì»¤ë°‹ ë° í‘¸ì‹œ

## ðŸ¤– ìžë™ ìƒì„±ëœ ì´ìŠˆ

ì´ ì´ìŠˆëŠ” ìžë™ Lint ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
ìžë™ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ì—†ëŠ” Lint ì—ëŸ¬ê°€ ë°œê²¬ë˜ì—ˆìœ¼ë¯€ë¡œ ìˆ˜ë™ ì¡°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.
`
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: lint-reports
          path: |
            lint-report.md
            lint-output.txt
            lint-recheck.txt
          retention-days: 30

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## ðŸ”§ ìžë™ Lint ìˆ˜ì • ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f lint-report.md ]; then
            cat lint-report.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.eslint_fix.outputs.fixed_files }}" == "true" ]; then
            if [ "${{ steps.lint_recheck.outputs.all_fixed }}" == "true" ]; then
              echo "âœ… **ê²°ê³¼:** ëª¨ë“  Lint ë¬¸ì œê°€ ìžë™ìœ¼ë¡œ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **ê²°ê³¼:** ì¼ë¶€ ë¬¸ì œëŠ” ìˆ˜ë™ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ inputs.create_pr }}" == "true" ] || [ "${{ github.event_name }}" == "schedule" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“‹ Pull Requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ steps.lint_check.outputs.has_errors }}" == "true" ]; then
              echo "âš ï¸ **ê²°ê³¼:** Lint ë¬¸ì œê°€ ìžˆì§€ë§Œ ìžë™ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **ê²°ê³¼:** Lint ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
            fi
          fi
