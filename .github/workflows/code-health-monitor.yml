name: Code Health Monitor

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (KST 11ì‹œ)ì— ì‹¤í–‰
    - cron: '0 2 * * *'
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Daily Code Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 30

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Configure git to use HTTPS instead of SSH
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install cloc
        run: sudo apt-get update && sudo apt-get install -y cloc

      - name: Collect code metrics
        id: metrics
        run: |
          echo "## ğŸ“Š ì½”ë“œ ê±´ê°• ì§€í‘œ" > health-report.md
          echo "" >> health-report.md
          echo "**ë‚ ì§œ:** $(date +%Y-%m-%d)" >> health-report.md
          echo "" >> health-report.md

          # ì½”ë“œ ë¼ì¸ ìˆ˜ í†µê³„
          echo "### ğŸ“ ì½”ë“œ í†µê³„" >> health-report.md
          echo "\`\`\`" >> health-report.md
          cloc app components lib electron --json --out=cloc.json || true
          if [ -f cloc.json ]; then
            total_code=$(jq '.SUM.code' cloc.json || echo "0")
            total_comments=$(jq '.SUM.comment' cloc.json || echo "0")
            echo "ì´ ì½”ë“œ ë¼ì¸: $total_code" >> health-report.md
            echo "ì´ ì£¼ì„ ë¼ì¸: $total_comments" >> health-report.md
            echo "CODE_LINES=$total_code" >> $GITHUB_OUTPUT
          fi
          echo "\`\`\`" >> health-report.md
          echo "" >> health-report.md

          # Git í™œë™ í†µê³„
          echo "### ğŸ”„ ìµœê·¼ í™œë™ (7ì¼)" >> health-report.md
          commits=$(git log --since="7 days ago" --oneline | wc -l)
          authors=$(git log --since="7 days ago" --format='%an' | sort -u | wc -l)
          echo "- ì»¤ë°‹ ìˆ˜: $commits" >> health-report.md
          echo "- ê¸°ì—¬ì ìˆ˜: $authors" >> health-report.md
          echo "COMMITS_7D=$commits" >> $GITHUB_OUTPUT
          echo "" >> health-report.md

          # íŒŒì¼ ë³€ê²½ ë¹ˆë„
          echo "### ğŸ”¥ ìµœê·¼ ë³€ê²½ì´ ì¦ì€ íŒŒì¼ (Top 10)" >> health-report.md
          echo "\`\`\`" >> health-report.md
          git log --since="30 days ago" --name-only --pretty=format: | \
            grep -E "\.(ts|tsx|js|jsx)$" | \
            sort | uniq -c | sort -rn | head -10 >> health-report.md
          echo "\`\`\`" >> health-report.md
          echo "" >> health-report.md

          # í° íŒŒì¼ ì°¾ê¸°
          echo "### ğŸ“¦ í° íŒŒì¼ (Top 10)" >> health-report.md
          echo "\`\`\`" >> health-report.md
          find app components lib electron -name "*.ts" -o -name "*.tsx" | \
            xargs wc -l | sort -rn | head -10 >> health-report.md
          echo "\`\`\`" >> health-report.md
          echo "" >> health-report.md

      - name: Run quick linting
        id: lint_check
        run: |
          echo "### âš ï¸ Lint ê²½ê³ " >> health-report.md

          # ESLint ì‹¤í–‰
          if pnpm run lint 2>&1 | tee lint-output.txt; then
            echo "âœ… Lint ì—ëŸ¬ ì—†ìŒ" >> health-report.md
            echo "LINT_STATUS=pass" >> $GITHUB_OUTPUT
          else
            echo "âŒ Lint ì—ëŸ¬ ë°œê²¬" >> health-report.md
            grep -E "error|warning" lint-output.txt | head -20 >> health-report.md || true
            echo "LINT_STATUS=fail" >> $GITHUB_OUTPUT
          fi
          echo "" >> health-report.md

      - name: Check test coverage trend
        id: coverage_check
        run: |
          echo "### ğŸ§ª í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€" >> health-report.md

          # í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          if pnpm run test:coverage:frontend --silent 2>&1 | tee test-output.txt; then
            if [ -f coverage/coverage-summary.json ]; then
              coverage=$(jq '.total.lines.pct' coverage/coverage-summary.json)
              echo "- í”„ë¡ íŠ¸ì—”ë“œ ì»¤ë²„ë¦¬ì§€: ${coverage}%" >> health-report.md
              echo "COVERAGE=$coverage" >> $GITHUB_OUTPUT

              # ì»¤ë²„ë¦¬ì§€ê°€ 70% ë¯¸ë§Œì´ë©´ ê²½ê³ 
              if (( $(echo "$coverage < 70" | bc -l) )); then
                echo "âš ï¸ ì»¤ë²„ë¦¬ì§€ê°€ 70% ë¯¸ë§Œì…ë‹ˆë‹¤" >> health-report.md
                echo "COVERAGE_WARNING=true" >> $GITHUB_OUTPUT
              fi
            fi
          fi
          echo "" >> health-report.md

      - name: Check for common anti-patterns
        id: antipattern_check
        run: |
          echo "### ğŸš© ì•ˆí‹°íŒ¨í„´ ì²´í¬" >> health-report.md

          # console.log ì‚¬ìš©
          console_count=$(grep -r "console\\.log" app components lib --include="*.ts" --include="*.tsx" | wc -l)
          echo "- console.log ì‚¬ìš©: $console_countê°œ" >> health-report.md

          # any íƒ€ì… ì‚¬ìš©
          any_count=$(grep -r ": any" app components lib --include="*.ts" --include="*.tsx" | wc -l)
          echo "- any íƒ€ì… ì‚¬ìš©: $any_countê°œ" >> health-report.md

          # TODO ì£¼ì„
          todo_count=$(grep -r "TODO\|FIXME" app components lib electron --include="*.ts" --include="*.tsx" | wc -l)
          echo "- TODO/FIXME: $todo_countê°œ" >> health-report.md

          # ê¸´ í•¨ìˆ˜ (100ì¤„ ì´ìƒ)
          long_functions=0
          for file in $(find app components lib electron -name "*.ts" -o -name "*.tsx"); do
            count=$(awk '/function.*{/{p=1} p{n++} /^}$/{if(n>100) print n; n=0; p=0}' "$file" | wc -l)
            long_functions=$((long_functions + count))
          done
          echo "- 100ì¤„ ì´ìƒ í•¨ìˆ˜: ${long_functions}ê°œ" >> health-report.md

          echo "CONSOLE_COUNT=$console_count" >> $GITHUB_OUTPUT
          echo "ANY_COUNT=$any_count" >> $GITHUB_OUTPUT
          echo "TODO_COUNT=$todo_count" >> $GITHUB_OUTPUT
          echo "" >> health-report.md

      - name: Dependency freshness check
        id: deps_check
        run: |
          echo "### ğŸ“¦ ì˜ì¡´ì„± ìƒíƒœ" >> health-report.md

          # ì˜¤ë˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
          outdated_output=$(pnpm outdated --format json 2>/dev/null || echo "[]")
          outdated_count=$(echo "$outdated_output" | jq 'length' 2>/dev/null || echo "0")
          # ìˆ«ìê°€ ì•„ë‹Œ ê²½ìš° 0ìœ¼ë¡œ ì„¤ì •
          outdated_count=$(echo "$outdated_count" | grep -o '[0-9]*' | head -1)
          outdated_count=${outdated_count:-0}

          echo "- ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€: ${outdated_count}ê°œ" >> health-report.md

          if [ "$outdated_count" -gt 0 ]; then
            echo "" >> health-report.md
            echo "ì£¼ìš” ì—…ë°ì´íŠ¸:" >> health-report.md
            echo "\`\`\`" >> health-report.md
            echo "$outdated_output" | jq -r '.[] | "- \(.name): \(.current) â†’ \(.latest)"' 2>/dev/null | head -10 >> health-report.md || echo "íŒŒì‹± ì‹¤íŒ¨" >> health-report.md
            echo "\`\`\`" >> health-report.md
          fi

          echo "OUTDATED_COUNT=$outdated_count" >> $GITHUB_OUTPUT
          echo "" >> health-report.md

      - name: Generate health score
        id: health_score
        run: |
          echo "### ğŸ¥ ì „ì²´ ê±´ê°•ë„ ì ìˆ˜" >> health-report.md

          score=100

          # Lint ì‹¤íŒ¨ ì‹œ -10ì 
          if [ "${{ steps.lint_check.outputs.LINT_STATUS }}" == "fail" ]; then
            score=$((score - 10))
          fi

          # ì»¤ë²„ë¦¬ì§€ ë‚®ìœ¼ë©´ -15ì 
          if [ "${{ steps.coverage_check.outputs.COVERAGE_WARNING }}" == "true" ]; then
            score=$((score - 15))
          fi

          # console.logê°€ ë§ìœ¼ë©´ -5ì 
          console_count=${{ steps.antipattern_check.outputs.CONSOLE_COUNT }}
          if [ "$console_count" -gt 50 ]; then
            score=$((score - 5))
          fi

          # any íƒ€ì…ì´ ë§ìœ¼ë©´ -10ì 
          any_count=${{ steps.antipattern_check.outputs.ANY_COUNT }}
          if [ "$any_count" -gt 30 ]; then
            score=$((score - 10))
          fi

          # ì˜¤ë˜ëœ íŒ¨í‚¤ì§€ê°€ ë§ìœ¼ë©´ -5ì 
          outdated_count=${{ steps.deps_check.outputs.OUTDATED_COUNT }}
          if [ "$outdated_count" -gt 20 ]; then
            score=$((score - 5))
          fi

          echo "HEALTH_SCORE=$score" >> $GITHUB_OUTPUT

          # ì ìˆ˜ì— ë”°ë¥¸ ì´ëª¨ì§€ì™€ í‰ê°€
          if [ "$score" -ge 90 ]; then
            emoji="ğŸŸ¢"
            status="ìš°ìˆ˜"
          elif [ "$score" -ge 75 ]; then
            emoji="ğŸŸ¡"
            status="ì–‘í˜¸"
          elif [ "$score" -ge 60 ]; then
            emoji="ğŸŸ "
            status="ì£¼ì˜"
          else
            emoji="ğŸ”´"
            status="ê°œì„  í•„ìš”"
          fi

          echo "" >> health-report.md
          echo "$emoji **ì ìˆ˜: ${score}/100 - ${status}**" >> health-report.md
          echo "" >> health-report.md

          # ê°œì„  ê¶Œì¥ì‚¬í•­
          if [ "$score" -lt 90 ]; then
            echo "### ğŸ’¡ ê°œì„  ê¶Œì¥ì‚¬í•­" >> health-report.md
            if [ "${{ steps.lint_check.outputs.LINT_STATUS }}" == "fail" ]; then
              echo "- [ ] Lint ì—ëŸ¬ ìˆ˜ì •" >> health-report.md
            fi
            if [ "${{ steps.coverage_check.outputs.COVERAGE_WARNING }}" == "true" ]; then
              echo "- [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í–¥ìƒ" >> health-report.md
            fi
            if [ "$console_count" -gt 50 ]; then
              echo "- [ ] í”„ë¡œë•ì…˜ ì½”ë“œì˜ console.log ì œê±°" >> health-report.md
            fi
            if [ "$any_count" -gt 30 ]; then
              echo "- [ ] any íƒ€ì… ì‚¬ìš© ì¤„ì´ê¸°" >> health-report.md
            fi
            if [ "$outdated_count" -gt 20 ]; then
              echo "- [ ] ì˜¤ë˜ëœ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸" >> health-report.md
            fi
          fi

      - name: Upload health report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: code-health-report-${{ github.run_number }}
          path: |
            health-report.md
            cloc.json
            lint-output.txt
          retention-days: 30

      - name: Update or create tracking issue
        if: always()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const score = '${{ steps.health_score.outputs.HEALTH_SCORE }}';
            const date = new Date().toISOString().split('T')[0];

            let reportContent = '';
            if (fs.existsSync('health-report.md')) {
              reportContent = fs.readFileSync('health-report.md', 'utf8');
            }

            // ê¸°ì¡´ ì¶”ì  ì´ìŠˆ ì°¾ê¸°
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'code-health,automated',
              state: 'open',
              per_page: 1
            });

            const body = `# ğŸ“Š ì½”ë“œ ê±´ê°•ë„ ë¦¬í¬íŠ¸\n\n**ìµœê·¼ ì—…ë°ì´íŠ¸:** ${date}\n**ê±´ê°•ë„ ì ìˆ˜:** ${score}/100\n\n---\n\n${reportContent}\n\n---\n\n*ì´ ë¦¬í¬íŠ¸ëŠ” ë§¤ì¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*\n*ìƒì„¸ ë‚´ì—­: [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰](../actions/runs/${{ github.run_id }})*`;

            if (issues.data.length > 0) {
              // ê¸°ì¡´ ì´ìŠˆ ì—…ë°ì´íŠ¸
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                title: `ğŸ“Š ì½”ë“œ ê±´ê°•ë„ ì¶”ì  (í˜„ì¬: ${score}/100)`,
                body: body
              });
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              // ìƒˆ ì´ìŠˆ ìƒì„±
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ“Š ì½”ë“œ ê±´ê°•ë„ ì¶”ì  (í˜„ì¬: ${score}/100)`,
                labels: ['code-health', 'automated', 'documentation'],
                body: body
              });
              console.log(`Created issue #${issue.data.number}`);
            }

      - name: Alert on low health score
        if: ${{ steps.health_score.outputs.HEALTH_SCORE < 70 }}
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const score = '${{ steps.health_score.outputs.HEALTH_SCORE }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ ì½”ë“œ ê±´ê°•ë„ ë‚®ìŒ: ${score}/100`,
              labels: ['code-health', 'priority-high', 'automated'],
              body: `# âš ï¸ ì½”ë“œ ê±´ê°•ë„ ê²½ê³ \n\n**í˜„ì¬ ì ìˆ˜:** ${score}/100\n\nì½”ë“œ ê±´ê°•ë„ê°€ 70ì  ë¯¸ë§Œìœ¼ë¡œ ë–¨ì–´ì¡ŒìŠµë‹ˆë‹¤. ì¦‰ì‹œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\n## ì¡°ì¹˜ í•„ìš”\n1. [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼](../actions/runs/${{ github.run_id }}) í™•ì¸\n2. health-report.md ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ ë° ê²€í† \n3. ê°œì„  ê¶Œì¥ì‚¬í•­ ì‹¤í–‰\n4. ì£¼ê°„ ë²„ê·¸ íƒìƒ‰ ì›Œí¬í”Œë¡œìš° ìˆ˜ë™ ì‹¤í–‰ ê³ ë ¤\n\nì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`
            });

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## ğŸ“Š ì½”ë“œ ê±´ê°•ë„ ì²´í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ê±´ê°•ë„ ì ìˆ˜:** ${{ steps.health_score.outputs.HEALTH_SCORE }}/100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f health-report.md ]; then
            cat health-report.md >> $GITHUB_STEP_SUMMARY
          fi
