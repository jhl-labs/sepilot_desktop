name: Automated Bug Hunt

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST 18ì‹œ)ì— ì‹¤í–‰
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      scan_depth:
        description: 'ìŠ¤ìº” ê¹Šì´ (quick, standard, deep)'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - deep
      target_areas:
        description: 'ê²€ì‚¬í•  ì˜ì—­ (ì‰¼í‘œë¡œ êµ¬ë¶„: electron,frontend,langgraph,mcp,rag)'
        required: false
        default: 'all'
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: read
  id-token: write

jobs:
  bug-hunt:
    name: Claude Bug Hunt
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Configure git to use HTTPS instead of SSH
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run static analysis tools
        id: static_analysis
        run: |
          echo "## ðŸ” ì •ì  ë¶„ì„ ê²°ê³¼" > static-analysis-report.md
          echo "" >> static-analysis-report.md

          # ESLint ì‹¤í–‰
          echo "### ESLint ë¶„ì„" >> static-analysis-report.md
          pnpm run lint --format json --output-file eslint-report.json || true

          if [ -f eslint-report.json ]; then
            error_count=$(jq '[.[] | .errorCount] | add' eslint-report.json || echo "0")
            warning_count=$(jq '[.[] | .warningCount] | add' eslint-report.json || echo "0")
            echo "- ì—ëŸ¬: $error_count" >> static-analysis-report.md
            echo "- ê²½ê³ : $warning_count" >> static-analysis-report.md
            echo "ESLINT_ERRORS=$error_count" >> $GITHUB_OUTPUT
            echo "ESLINT_WARNINGS=$warning_count" >> $GITHUB_OUTPUT
          fi
          echo "" >> static-analysis-report.md

          # TypeScript íƒ€ìž… ì²´í¬
          echo "### TypeScript íƒ€ìž… ì²´í¬" >> static-analysis-report.md
          if pnpm run type-check 2>&1 | tee typescript-errors.txt; then
            echo "âœ… íƒ€ìž… ì—ëŸ¬ ì—†ìŒ" >> static-analysis-report.md
            echo "TS_ERRORS=0" >> $GITHUB_OUTPUT
          else
            error_count=$(grep -c "error TS" typescript-errors.txt || echo "0")
            echo "âŒ íƒ€ìž… ì—ëŸ¬ ë°œê²¬: $error_count" >> static-analysis-report.md
            echo "TS_ERRORS=$error_count" >> $GITHUB_OUTPUT
            cat typescript-errors.txt >> static-analysis-report.md
          fi
          echo "" >> static-analysis-report.md

          # ì½”ë“œ ì¤‘ë³µ ê²€ì‚¬
          echo "### ì½”ë“œ ì¤‘ë³µ ê²€ì‚¬" >> static-analysis-report.md
          npx jscpd app components lib electron --format json --output jscpd-report.json || true

          if [ -f jscpd-report.json ]; then
            duplication_rate=$(jq '.statistics.total.percentage' jscpd-report.json || echo "0")
            echo "- ì¤‘ë³µë¥ : ${duplication_rate}%" >> static-analysis-report.md
            echo "DUPLICATION_RATE=$duplication_rate" >> $GITHUB_OUTPUT
          fi

      - name: Identify problematic areas
        id: problem_areas
        run: |
          echo "## ðŸŽ¯ ë¶„ì„ ëŒ€ìƒ ì˜ì—­" > problem-areas.md
          echo "" >> problem-areas.md

          # ìµœê·¼ ìžì£¼ ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
          echo "### ìµœê·¼ ë³€ê²½ì´ ìž¦ì€ íŒŒì¼ (ìž ìž¬ì  ë²„ê·¸ ì˜ì—­)" >> problem-areas.md
          git log --since="1 month ago" --name-only --pretty=format: | sort | uniq -c | sort -rn | head -20 >> problem-areas.md
          echo "" >> problem-areas.md

          # ë³µìž¡ë„ê°€ ë†’ì€ íŒŒì¼ ì°¾ê¸°
          echo "### ë³µìž¡í•œ íŒŒì¼ (Lines of Code)" >> problem-areas.md
          find app components lib electron -name "*.ts" -o -name "*.tsx" | xargs wc -l | sort -rn | head -20 >> problem-areas.md
          echo "" >> problem-areas.md

          # TODO/FIXME ì£¼ì„ ì°¾ê¸°
          echo "### TODO/FIXME í•­ëª©" >> problem-areas.md
          grep -r "TODO\|FIXME\|HACK\|XXX" app components lib electron --include="*.ts" --include="*.tsx" -n | head -30 >> problem-areas.md || echo "ì—†ìŒ" >> problem-areas.md

      - name: Run Claude Bug Hunt Analysis
        id: claude_analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            # ìžë™ ë²„ê·¸ íƒìƒ‰ ë¯¸ì…˜

            ## ëª©í‘œ
            ì½”ë“œë² ì´ìŠ¤ì—ì„œ ìž ìž¬ì ì¸ ë²„ê·¸, ì½”ë“œ í’ˆì§ˆ ë¬¸ì œ, ë³´ì•ˆ ì·¨ì•½ì ì„ íƒìƒ‰í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.

            ## ìŠ¤ìº” ê¹Šì´: ${{ inputs.scan_depth || 'standard' }}
            ## ëŒ€ìƒ ì˜ì—­: ${{ inputs.target_areas || 'all' }}

            ## ë¶„ì„ í•­ëª©

            ### 1. ì •ì  ë¶„ì„ ê²°ê³¼ ê²€í† 
            ë‹¤ìŒ íŒŒì¼ë“¤ì„ ì½ê³  ì£¼ìš” ë¬¸ì œì ì„ íŒŒì•…í•˜ì„¸ìš”:
            - static-analysis-report.md
            - problem-areas.md
            - eslint-report.json (ìžˆëŠ” ê²½ìš°)
            - typescript-errors.txt (ìžˆëŠ” ê²½ìš°)

            ### 2. ì½”ë“œ íŒ¨í„´ ë¶„ì„
            ë‹¤ìŒ ì˜ì—­ì—ì„œ ìž ìž¬ì  ë²„ê·¸ë¥¼ íƒìƒ‰í•˜ì„¸ìš”:

            **ë³´ì•ˆ ì·¨ì•½ì :**
            - XSS, SQL Injection, Command Injection ê°€ëŠ¥ì„±
            - í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸, API í‚¤
            - ì•ˆì „í•˜ì§€ ì•Šì€ íŒŒì¼ ì²˜ë¦¬
            - IPC í†µì‹  ë³´ì•ˆ ë¬¸ì œ

            **ëŸ°íƒ€ìž„ ì—ëŸ¬ ê°€ëŠ¥ì„±:**
            - Null/Undefined ì°¸ì¡°
            - íƒ€ìž… ë¶ˆì¼ì¹˜
            - ë¹„ë™ê¸° ì²˜ë¦¬ ì˜¤ë¥˜ (Promise, async/await)
            - ì—ëŸ¬ í•¸ë“¤ë§ ëˆ„ë½

            **ë¡œì§ ë²„ê·¸:**
            - ì—£ì§€ ì¼€ì´ìŠ¤ ì²˜ë¦¬ ëˆ„ë½
            - ê²½ìŸ ì¡°ê±´ (Race Condition)
            - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±
            - ë¬´í•œ ë£¨í”„ ê°€ëŠ¥ì„±

            **ì½”ë“œ í’ˆì§ˆ:**
            - ê³¼ë„í•˜ê²Œ ë³µìž¡í•œ í•¨ìˆ˜
            - ì¤‘ë³µ ì½”ë“œ
            - í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¶€ì¡±
            - ë¬¸ì„œí™” ë¶€ì¡±

            ### 3. íŠ¹ì • ì˜ì—­ ì§‘ì¤‘ ê²€ì‚¬
            ${{ inputs.target_areas == 'all' && 'ì „ì²´ ì½”ë“œë² ì´ìŠ¤' || inputs.target_areas }}ë¥¼ ì§‘ì¤‘ ë¶„ì„í•˜ì„¸ìš”.

            ### 4. ê²°ê³¼ ë³´ê³ ì„œ ìƒì„±
            ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ bug-hunt-report.md íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”:

            ```markdown
            # ðŸ› ìžë™ ë²„ê·¸ íƒìƒ‰ ë³´ê³ ì„œ

            **ì‹¤í–‰ ë‚ ì§œ:** $(date)
            **ìŠ¤ìº” ê¹Šì´:** ${{ inputs.scan_depth || 'standard' }}
            **ëŒ€ìƒ ì˜ì—­:** ${{ inputs.target_areas || 'all' }}

            ## ðŸ“Š ìš”ì•½

            - ë°œê²¬ëœ ìž ìž¬ì  ë²„ê·¸: [ê°œìˆ˜]
            - ì‹¬ê°ë„ ë†’ìŒ: [ê°œìˆ˜]
            - ì‹¬ê°ë„ ì¤‘ê°„: [ê°œìˆ˜]
            - ì‹¬ê°ë„ ë‚®ìŒ: [ê°œìˆ˜]

            ## ðŸš¨ ì£¼ìš” ë°œê²¬ì‚¬í•­

            ### 1. [ë²„ê·¸ ì œëª©]
            - **íŒŒì¼:** [íŒŒì¼ê²½ë¡œ:ë¼ì¸ë²ˆí˜¸]
            - **ì‹¬ê°ë„:** [High/Medium/Low]
            - **ì¹´í…Œê³ ë¦¬:** [Security/Runtime/Logic/Quality]
            - **ì„¤ëª…:** [ìƒì„¸ ì„¤ëª…]
            - **ì˜í–¥:** [ì˜ˆìƒë˜ëŠ” ì˜í–¥]
            - **í•´ê²° ë°©ë²•:** [ê¶Œìž¥ ìˆ˜ì • ë°©ë²•]

            ### 2. [ë²„ê·¸ ì œëª©]
            ...

            ## ðŸ’¡ ê¶Œìž¥ì‚¬í•­

            [ì „ë°˜ì ì¸ ê°œì„  ê¶Œìž¥ì‚¬í•­]

            ## ðŸ” ë‹¤ìŒ ê²€í†  í•„ìš” ì˜ì—­

            [ì¶”ê°€ë¡œ ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•œ ì˜ì—­]
            ```

            ## ì‹¤í–‰ ì§€ì¹¨
            1. ì •ì  ë¶„ì„ ê²°ê³¼ë¥¼ ë¨¼ì € ì½ìœ¼ì„¸ìš”
            2. ë¬¸ì œê°€ ë§Žì´ ë³´ê³ ëœ íŒŒì¼ë“¤ì„ ìš°ì„ ì ìœ¼ë¡œ ê²€í† í•˜ì„¸ìš”
            3. ì‹¤ì œ ì½”ë“œë¥¼ ì½ê³  ë¬¸ë§¥ì„ ì´í•´í•˜ì„¸ìš”
            4. ë°œê²¬í•œ ë¬¸ì œë“¤ì„ ì‹¬ê°ë„ë³„ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”
            5. ë³´ê³ ì„œë¥¼ bug-hunt-report.mdë¡œ ìž‘ì„±í•˜ì„¸ìš”

            ì£¼ì˜: ë‹¨ìˆœížˆ ë„êµ¬ì˜ ê²½ê³ ë¥¼ ë‚˜ì—´í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì‹¤ì œ ë²„ê·¸ ê°€ëŠ¥ì„±ì´ ìžˆëŠ” ê²ƒë§Œ ë³´ê³ í•˜ì„¸ìš”.

          claude_args: '--allowed-tools "Read:*,Grep:*,Glob:*,Write:bug-hunt-report.md"'

      - name: Check if report was generated
        id: check_report
        run: |
          if [ -f bug-hunt-report.md ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT

            # ë°œê²¬ëœ ë²„ê·¸ ê°œìˆ˜ ì¶”ì¶œ
            bug_count=$(grep -c "### [0-9]" bug-hunt-report.md || echo "0")
            echo "bug_count=$bug_count" >> $GITHUB_OUTPUT

            # ì‹¬ê°ë„ ë†’ì€ ë²„ê·¸ ê°œìˆ˜
            high_severity=$(grep -c "ì‹¬ê°ë„.*High\|Severity.*High" bug-hunt-report.md || echo "0")
            echo "high_severity=$high_severity" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "bug_count=0" >> $GITHUB_OUTPUT
            echo "high_severity=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload analysis reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: bug-hunt-reports
          path: |
            bug-hunt-report.md
            static-analysis-report.md
            problem-areas.md
            eslint-report.json
            typescript-errors.txt
            jscpd-report.json
          retention-days: 90

      - name: Create issue for critical findings
        if: steps.check_report.outputs.high_severity > 0
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const bugCount = '${{ steps.check_report.outputs.bug_count }}';
            const highSeverity = '${{ steps.check_report.outputs.high_severity }}';

            let reportContent = 'ë³´ê³ ì„œë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            if (fs.existsSync('bug-hunt-report.md')) {
              reportContent = fs.readFileSync('bug-hunt-report.md', 'utf8');

              // ë„ˆë¬´ ê¸´ ê²½ìš° ìš”ì•½ë§Œ í¬í•¨
              if (reportContent.length > 60000) {
                const summaryEnd = reportContent.indexOf('## ðŸš¨ ì£¼ìš” ë°œê²¬ì‚¬í•­');
                const findingsEnd = reportContent.indexOf('## ðŸ’¡ ê¶Œìž¥ì‚¬í•­');
                if (summaryEnd > 0 && findingsEnd > summaryEnd) {
                  reportContent = reportContent.substring(0, findingsEnd) +
                    '\n\n*ì „ì²´ ë³´ê³ ì„œëŠ” [Artifacts](../actions/runs/${{ github.run_id }})ë¥¼ í™•ì¸í•˜ì„¸ìš”.*';
                }
              }
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ› ìžë™ ë²„ê·¸ íƒìƒ‰ ê²°ê³¼: ${highSeverity}ê°œì˜ ì‹¬ê°í•œ ë¬¸ì œ ë°œê²¬`,
              labels: ['bug', 'automated-scan', 'priority-high'],
              body: `# ðŸ” ìžë™ ë²„ê·¸ íƒìƒ‰ ë³´ê³ ì„œ

**ì‹¤í–‰ ì¼ì‹œ:** ${new Date().toISOString()}
**ì›Œí¬í”Œë¡œìš°:** [Run #${{ github.run_id }}](../actions/runs/${{ github.run_id }})

## ðŸ“Š ìš”ì•½

- ì´ ë°œê²¬ í•­ëª©: ${bugCount}ê°œ
- ðŸš¨ ì‹¬ê°ë„ ë†’ìŒ: ${highSeverity}ê°œ
- âš ï¸ ì¤‘ê°„/ë‚®ìŒ: ${bugCount - highSeverity}ê°œ

---

${reportContent}

---

**ìžë™ ìƒì„±ëœ ì´ìŠˆìž…ë‹ˆë‹¤.** ìƒì„¸ ë‚´ìš©ì€ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ì˜ ì•„í‹°íŒ©íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
`
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Comment on existing issues
        if: steps.check_report.outputs.bug_count > 0 && steps.check_report.outputs.high_severity == 0
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const bugCount = '${{ steps.check_report.outputs.bug_count }}';

            // ê¸°ì¡´ì˜ ìžë™ ìŠ¤ìº” ì´ìŠˆê°€ ìžˆëŠ”ì§€ í™•ì¸
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'automated-scan',
              state: 'open',
              per_page: 1
            });

            const message = `## ðŸ” ì •ê¸° ë²„ê·¸ ìŠ¤ìº” ì™„ë£Œ

**ì‹¤í–‰ ì¼ì‹œ:** ${new Date().toISOString()}
**ë°œê²¬ í•­ëª©:** ${bugCount}ê°œ (ì‹¬ê°ë„ ë‚®ìŒ)

ìƒì„¸ ë‚´ìš©ì€ [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼](../actions/runs/${{ github.run_id }})ì˜ ì•„í‹°íŒ©íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.

ì‹¬ê°í•œ ë¬¸ì œëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. âœ…
`;

            if (issues.data.length > 0) {
              // ê¸°ì¡´ ì´ìŠˆì— ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: message
              });
            }

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ› ìžë™ ë²„ê·¸ íƒìƒ‰ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_report.outputs.report_exists }}" == "true" ]; then
            echo "### ðŸ“Š ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "- ë°œê²¬ëœ í•­ëª©: ${{ steps.check_report.outputs.bug_count }}ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "- ì‹¬ê°ë„ ë†’ìŒ: ${{ steps.check_report.outputs.high_severity }}ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.check_report.outputs.high_severity }}" -gt 0 ]; then
              echo "ðŸš¨ **ì‹¬ê°í•œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!** ìžë™ìœ¼ë¡œ ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… ì‹¬ê°í•œ ë¬¸ì œëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ì•„í‹°íŒ©íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "ìƒì„¸ ë³´ê³ ì„œëŠ” [Artifacts](../actions/runs/${{ github.run_id }})ì—ì„œ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
