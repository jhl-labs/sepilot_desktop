name: Automated Bug Hunt

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST 18ì‹œ)ì— ì‹¤í–‰
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      scan_depth:
        description: 'ìŠ¤ìº” ê¹Šì´ (quick, standard, deep)'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - deep
      target_areas:
        description: 'ê²€ì‚¬í•  ì˜ì—­ (ì‰¼í‘œë¡œ êµ¬ë¶„: electron,frontend,langgraph,mcp,rag)'
        required: false
        default: 'all'
        type: string
      auto_fix:
        description: 'ìë™ ìˆ˜ì • ì‹œë„ (true/false)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  bug-hunt:
    name: Claude Bug Hunt & Auto-fix
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run static analysis tools
        id: static_analysis
        run: |
          echo "## ğŸ” ì •ì  ë¶„ì„ ê²°ê³¼" > static-analysis-report.md
          echo "" >> static-analysis-report.md

          # ESLint ì‹¤í–‰
          echo "### ESLint ë¶„ì„" >> static-analysis-report.md
          pnpm run lint --format json --output-file eslint-report.json || true

          if [ -f eslint-report.json ]; then
            error_count=$(jq '[.[] | .errorCount] | add' eslint-report.json || echo "0")
            warning_count=$(jq '[.[] | .warningCount] | add' eslint-report.json || echo "0")
            echo "- ì—ëŸ¬: $error_count" >> static-analysis-report.md
            echo "- ê²½ê³ : $warning_count" >> static-analysis-report.md
            echo "ESLINT_ERRORS=$error_count" >> $GITHUB_OUTPUT
            echo "ESLINT_WARNINGS=$warning_count" >> $GITHUB_OUTPUT
          fi
          echo "" >> static-analysis-report.md

          # TypeScript íƒ€ì… ì²´í¬
          echo "### TypeScript íƒ€ì… ì²´í¬" >> static-analysis-report.md
          if pnpm run type-check 2>&1 | tee typescript-errors.txt; then
            echo "âœ… íƒ€ì… ì—ëŸ¬ ì—†ìŒ" >> static-analysis-report.md
            echo "TS_ERRORS=0" >> $GITHUB_OUTPUT
          else
            error_count=$(grep -c "error TS" typescript-errors.txt || echo "0")
            echo "âŒ íƒ€ì… ì—ëŸ¬ ë°œê²¬: $error_count" >> static-analysis-report.md
            echo "TS_ERRORS=$error_count" >> $GITHUB_OUTPUT
            cat typescript-errors.txt >> static-analysis-report.md
          fi
          echo "" >> static-analysis-report.md

          # ì½”ë“œ ì¤‘ë³µ ê²€ì‚¬
          echo "### ì½”ë“œ ì¤‘ë³µ ê²€ì‚¬" >> static-analysis-report.md
          npx jscpd app components lib electron --format json --output jscpd-report.json || true

          if [ -f jscpd-report.json ]; then
            duplication_rate=$(jq '.statistics.total.percentage' jscpd-report.json || echo "0")
            echo "- ì¤‘ë³µë¥ : ${duplication_rate}%" >> static-analysis-report.md
            echo "DUPLICATION_RATE=$duplication_rate" >> $GITHUB_OUTPUT
          fi

      - name: Identify problematic areas
        id: problem_areas
        run: |
          echo "## ğŸ¯ ë¶„ì„ ëŒ€ìƒ ì˜ì—­" > problem-areas.md
          echo "" >> problem-areas.md

          # ìµœê·¼ ìì£¼ ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
          echo "### ìµœê·¼ ë³€ê²½ì´ ì¦ì€ íŒŒì¼ (ì ì¬ì  ë²„ê·¸ ì˜ì—­)" >> problem-areas.md
          git log --since="1 month ago" --name-only --pretty=format: | sort | uniq -c | sort -rn | head -20 >> problem-areas.md
          echo "" >> problem-areas.md

          # ë³µì¡ë„ê°€ ë†’ì€ íŒŒì¼ ì°¾ê¸°
          echo "### ë³µì¡í•œ íŒŒì¼ (Lines of Code)" >> problem-areas.md
          find app components lib electron -name "*.ts" -o -name "*.tsx" | xargs wc -l | sort -rn | head -20 >> problem-areas.md
          echo "" >> problem-areas.md

          # TODO/FIXME ì£¼ì„ ì°¾ê¸°
          echo "### TODO/FIXME í•­ëª©" >> problem-areas.md
          grep -r "TODO\|FIXME\|HACK\|XXX" app components lib electron --include="*.ts" --include="*.tsx" -n | head -30 >> problem-areas.md || echo "ì—†ìŒ" >> problem-areas.md

      - name: Run Claude Bug Hunt Analysis
        id: claude_analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            # ìë™ ë²„ê·¸ íƒìƒ‰ ë° ìˆ˜ì • ë¯¸ì…˜

            ## ëª©í‘œ
            ì½”ë“œë² ì´ìŠ¤ì—ì„œ ì ì¬ì ì¸ ë²„ê·¸, ì½”ë“œ í’ˆì§ˆ ë¬¸ì œ, ë³´ì•ˆ ì·¨ì•½ì ì„ íƒìƒ‰í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.
            **ì¤‘ìš”:** ë°œê²¬í•œ ë²„ê·¸ë¥¼ ë³´ê³ ì„œì— ê¸°ë¡í•˜ë˜, ìë™ ìˆ˜ì •ì€ í•˜ì§€ ë§ˆì„¸ìš”. ë³´ê³ ì„œë§Œ ìƒì„±í•©ë‹ˆë‹¤.

            ## ìŠ¤ìº” ê¹Šì´: ${{ inputs.scan_depth || 'standard' }}
            ## ëŒ€ìƒ ì˜ì—­: ${{ inputs.target_areas || 'all' }}

            ## ë¶„ì„ í•­ëª©

            ### 1. ì •ì  ë¶„ì„ ê²°ê³¼ ê²€í† 
            ë‹¤ìŒ íŒŒì¼ë“¤ì„ ì½ê³  ì£¼ìš” ë¬¸ì œì ì„ íŒŒì•…í•˜ì„¸ìš”:
            - static-analysis-report.md
            - problem-areas.md
            - eslint-report.json (ìˆëŠ” ê²½ìš°)
            - typescript-errors.txt (ìˆëŠ” ê²½ìš°)

            ### 2. ì½”ë“œ íŒ¨í„´ ë¶„ì„
            ë‹¤ìŒ ì˜ì—­ì—ì„œ ì ì¬ì  ë²„ê·¸ë¥¼ íƒìƒ‰í•˜ì„¸ìš”:

            **ë³´ì•ˆ ì·¨ì•½ì :**
            - XSS, SQL Injection, Command Injection ê°€ëŠ¥ì„±
            - í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸, API í‚¤
            - ì•ˆì „í•˜ì§€ ì•Šì€ íŒŒì¼ ì²˜ë¦¬
            - IPC í†µì‹  ë³´ì•ˆ ë¬¸ì œ

            **ëŸ°íƒ€ì„ ì—ëŸ¬ ê°€ëŠ¥ì„±:**
            - Null/Undefined ì°¸ì¡°
            - íƒ€ì… ë¶ˆì¼ì¹˜
            - ë¹„ë™ê¸° ì²˜ë¦¬ ì˜¤ë¥˜ (Promise, async/await)
            - ì—ëŸ¬ í•¸ë“¤ë§ ëˆ„ë½

            **ë¡œì§ ë²„ê·¸:**
            - ì—£ì§€ ì¼€ì´ìŠ¤ ì²˜ë¦¬ ëˆ„ë½
            - ê²½ìŸ ì¡°ê±´ (Race Condition)
            - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±
            - ë¬´í•œ ë£¨í”„ ê°€ëŠ¥ì„±

            **ì½”ë“œ í’ˆì§ˆ:**
            - ê³¼ë„í•˜ê²Œ ë³µì¡í•œ í•¨ìˆ˜
            - ì¤‘ë³µ ì½”ë“œ
            - í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¶€ì¡±
            - ë¬¸ì„œí™” ë¶€ì¡±

            ### 3. íŠ¹ì • ì˜ì—­ ì§‘ì¤‘ ê²€ì‚¬
            ${{ inputs.target_areas == 'all' && 'ì „ì²´ ì½”ë“œë² ì´ìŠ¤' || inputs.target_areas }}ë¥¼ ì§‘ì¤‘ ë¶„ì„í•˜ì„¸ìš”.

            ### 4. ê²°ê³¼ ë³´ê³ ì„œ ìƒì„±
            ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ bug-hunt-report.md íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”:

            ```markdown
            # ğŸ› ìë™ ë²„ê·¸ íƒìƒ‰ ë³´ê³ ì„œ

            **ì‹¤í–‰ ë‚ ì§œ:** $(date)
            **ìŠ¤ìº” ê¹Šì´:** ${{ inputs.scan_depth || 'standard' }}
            **ëŒ€ìƒ ì˜ì—­:** ${{ inputs.target_areas || 'all' }}

            ## ğŸ“Š ìš”ì•½

            - ë°œê²¬ëœ ì ì¬ì  ë²„ê·¸: [ê°œìˆ˜]
            - ì‹¬ê°ë„ ë†’ìŒ: [ê°œìˆ˜]
            - ì‹¬ê°ë„ ì¤‘ê°„: [ê°œìˆ˜]
            - ì‹¬ê°ë„ ë‚®ìŒ: [ê°œìˆ˜]

            ## ğŸš¨ ì£¼ìš” ë°œê²¬ì‚¬í•­

            ### 1. [ë²„ê·¸ ì œëª©]
            - **íŒŒì¼:** [íŒŒì¼ê²½ë¡œ:ë¼ì¸ë²ˆí˜¸]
            - **ì‹¬ê°ë„:** [High/Medium/Low]
            - **ì¹´í…Œê³ ë¦¬:** [Security/Runtime/Logic/Quality]
            - **ì„¤ëª…:** [ìƒì„¸ ì„¤ëª…]
            - **ì˜í–¥:** [ì˜ˆìƒë˜ëŠ” ì˜í–¥]
            - **í•´ê²° ë°©ë²•:** [ê¶Œì¥ ìˆ˜ì • ë°©ë²•]
            - **ìë™ ìˆ˜ì • ê°€ëŠ¥:** [Yes/No]

            ### 2. [ë²„ê·¸ ì œëª©]
            ...

            ## ğŸ’¡ ê¶Œì¥ì‚¬í•­

            [ì „ë°˜ì ì¸ ê°œì„  ê¶Œì¥ì‚¬í•­]

            ## ğŸ” ë‹¤ìŒ ê²€í†  í•„ìš” ì˜ì—­

            [ì¶”ê°€ë¡œ ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•œ ì˜ì—­]
            ```

            ## ì‹¤í–‰ ì§€ì¹¨
            1. ì •ì  ë¶„ì„ ê²°ê³¼ë¥¼ ë¨¼ì € ì½ìœ¼ì„¸ìš”
            2. ë¬¸ì œê°€ ë§ì´ ë³´ê³ ëœ íŒŒì¼ë“¤ì„ ìš°ì„ ì ìœ¼ë¡œ ê²€í† í•˜ì„¸ìš”
            3. ì‹¤ì œ ì½”ë“œë¥¼ ì½ê³  ë¬¸ë§¥ì„ ì´í•´í•˜ì„¸ìš”
            4. ë°œê²¬í•œ ë¬¸ì œë“¤ì„ ì‹¬ê°ë„ë³„ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”
            5. ê° ë²„ê·¸ì— ëŒ€í•´ ìë™ ìˆ˜ì • ê°€ëŠ¥ ì—¬ë¶€ í‘œì‹œ
            6. ë³´ê³ ì„œë¥¼ bug-hunt-report.mdë¡œ ì‘ì„±í•˜ì„¸ìš”

            **ì¤‘ìš”:** ì½”ë“œ ìˆ˜ì •ì€ í•˜ì§€ ë§ˆì„¸ìš”. ë³´ê³ ì„œë§Œ ì‘ì„±í•©ë‹ˆë‹¤.

          claude_args: '--allowed-tools "Read:*,Grep:*,Glob:*,Write:bug-hunt-report.md"'

      - name: Check if report was generated
        id: check_report
        run: |
          if [ -f bug-hunt-report.md ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT

            # ë°œê²¬ëœ ë²„ê·¸ ê°œìˆ˜ ì¶”ì¶œ
            bug_count=$(grep -c "### [0-9]" bug-hunt-report.md || echo "0")
            echo "bug_count=$bug_count" >> $GITHUB_OUTPUT

            # ì‹¬ê°ë„ ë†’ì€ ë²„ê·¸ ê°œìˆ˜
            high_severity=$(grep -c "ì‹¬ê°ë„.*High\|Severity.*High" bug-hunt-report.md || echo "0")
            echo "high_severity=$high_severity" >> $GITHUB_OUTPUT

            # ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ ë²„ê·¸ ê°œìˆ˜
            auto_fixable=$(grep -c "ìë™ ìˆ˜ì • ê°€ëŠ¥.*Yes\|ìë™ ìˆ˜ì • ê°€ëŠ¥: Yes" bug-hunt-report.md || echo "0")
            echo "auto_fixable=$auto_fixable" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "bug_count=0" >> $GITHUB_OUTPUT
            echo "high_severity=0" >> $GITHUB_OUTPUT
            echo "auto_fixable=0" >> $GITHUB_OUTPUT
          fi

      - name: Attempt Auto-fix with Claude
        if: steps.check_report.outputs.auto_fixable != '0' && (inputs.auto_fix == 'true' || github.event_name == 'schedule')
        id: claude_fix
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            # ë²„ê·¸ ìë™ ìˆ˜ì • ë¯¸ì…˜

            ## ëª©í‘œ
            bug-hunt-report.mdì— ê¸°ë¡ëœ ë²„ê·¸ ì¤‘ "ìë™ ìˆ˜ì • ê°€ëŠ¥: Yes"ë¡œ í‘œì‹œëœ ê²ƒë“¤ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.

            ## ì¤‘ìš” ì§€ì¹¨

            1. **bug-hunt-report.mdë¥¼ ì½ê³ ** ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ ë²„ê·¸ë§Œ ìˆ˜ì •
            2. **ì•ˆì „í•œ ìˆ˜ì •ë§Œ ì§„í–‰**: ë¡œì§ ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš° ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
            3. **í•œ ë²ˆì— í•˜ë‚˜ì”©**: ê° ë²„ê·¸ë¥¼ ì‹ ì¤‘í•˜ê²Œ ìˆ˜ì •
            4. **í…ŒìŠ¤íŠ¸ ì‹¤í–‰**: ìˆ˜ì • í›„ í•´ë‹¹ ì˜ì—­ì˜ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ëŠ”ì§€ í™•ì¸
            5. **ë³´ìˆ˜ì ìœ¼ë¡œ**: í™•ì‹ ì´ ì—†ìœ¼ë©´ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ

            ## ìˆ˜ì • ê°€ëŠ¥í•œ í•­ëª© ì˜ˆì‹œ

            âœ… **ì•ˆì „í•œ ìˆ˜ì •:**
            - Null ì²´í¬ ì¶”ê°€
            - íƒ€ì… ë‹¨ì–¸ ìˆ˜ì •
            - ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³€ìˆ˜/import ì œê±°
            - ëª…ë°±í•œ ì˜¤íƒ€ ìˆ˜ì •
            - í¬ë§·íŒ… ë¬¸ì œ
            - ëˆ„ë½ëœ ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€ (ë‹¨ìˆœí•œ ê²½ìš°)

            âŒ **ìˆ˜ì •í•˜ì§€ ì•Šì„ í•­ëª©:**
            - ë³µì¡í•œ ë¡œì§ ë³€ê²½
            - ì•Œê³ ë¦¬ì¦˜ ê°œì„ 
            - ì•„í‚¤í…ì²˜ ë³€ê²½
            - ë¶ˆí™•ì‹¤í•œ ë²„ê·¸
            - í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°

            ## ì‘ì—… ìˆœì„œ

            1. bug-hunt-report.md ì½ê¸°
            2. "ìë™ ìˆ˜ì • ê°€ëŠ¥: Yes" í•­ëª© ì°¾ê¸°
            3. í•´ë‹¹ íŒŒì¼ ì½ê¸°
            4. ì‹ ì¤‘í•˜ê²Œ ìˆ˜ì •
            5. ìˆ˜ì • ë‚´ìš©ì„ bug-fixes-applied.mdì— ê¸°ë¡
            6. ë‹¤ìŒ ë²„ê·¸ë¡œ ì´ë™

            ## ìˆ˜ì • ê¸°ë¡ í˜•ì‹

            bug-fixes-applied.md íŒŒì¼ì— ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ê¸°ë¡:

            ```markdown
            # ğŸ”§ ìë™ ìˆ˜ì • ì ìš© ë‚´ì—­

            ## ìˆ˜ì •ëœ ë²„ê·¸

            ### 1. [ë²„ê·¸ ì œëª©]
            - **íŒŒì¼:** [íŒŒì¼ê²½ë¡œ]
            - **ìˆ˜ì • ë‚´ìš©:** [ë¬´ì—‡ì„ ìˆ˜ì •í–ˆëŠ”ì§€]
            - **ì´ìœ :** [ì™œ ì•ˆì „í•œ ìˆ˜ì •ì¸ì§€]

            ### 2. [ë²„ê·¸ ì œëª©]
            ...

            ## ìˆ˜ì •í•˜ì§€ ì•Šì€ ë²„ê·¸

            ### 1. [ë²„ê·¸ ì œëª©]
            - **íŒŒì¼:** [íŒŒì¼ê²½ë¡œ]
            - **ì´ìœ :** [ì™œ ìˆ˜ì •í•˜ì§€ ì•Šì•˜ëŠ”ì§€]
            ```

            **ë³´ìˆ˜ì ìœ¼ë¡œ ì‘ì—…í•˜ì„¸ìš”.** ë¶ˆí™•ì‹¤í•˜ë©´ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”.

          claude_args: '--allowed-tools "Read:*,Edit:*,Grep:*,Glob:*,Write:bug-fixes-applied.md,Bash:pnpm run test*,Bash:pnpm run lint"'

      - name: Check if fixes were applied
        if: steps.claude_fix.conclusion != 'skipped'
        id: check_fixes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "âœ… ìë™ ìˆ˜ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤" > fix-summary.md
            echo "" >> fix-summary.md
            echo "## ìˆ˜ì •ëœ íŒŒì¼:" >> fix-summary.md
            git status --short >> fix-summary.md
          else
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ê±°ë‚˜ ìˆ˜ì •ì´ ì•ˆì „í•˜ì§€ ì•Šì•„ ì ìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." > fix-summary.md
          fi

      - name: Create fix branch and commit
        if: steps.check_fixes.outputs.has_fixes == 'true'
        id: create_branch
        run: |
          # ë¸Œëœì¹˜ ì´ë¦„ ìƒì„±
          BRANCH_NAME="auto-bug-fix/$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # ìƒˆ ë¸Œëœì¹˜ ìƒì„± ë° ì²´í¬ì•„ì›ƒ
          git checkout -b "$BRANCH_NAME"

          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          cat > /tmp/commit_msg.txt << 'COMMIT_MSG'
          fix: ìë™ ë²„ê·¸ ìˆ˜ì • ì ìš©

          ìë™ ë²„ê·¸ íƒìƒ‰ ì›Œí¬í”Œë¡œìš°ì—ì„œ ë°œê²¬í•œ ë²„ê·¸ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

          - ë²„ê·¸ íƒìƒ‰ ë³´ê³ ì„œ: bug-hunt-report.md ì°¸ì¡°
          - ìˆ˜ì • ë‚´ì—­: bug-fixes-applied.md ì°¸ì¡°

          âš ï¸ ì´ PRì€ AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.
          ì½”ë“œ ë¦¬ë·°ë¥¼ í†µí•´ ìˆ˜ì • ë‚´ìš©ì„ ê²€ì¦í•œ í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.

          [skip ci]
          COMMIT_MSG

          git add -A
          git commit -F /tmp/commit_msg.txt || echo "No changes to commit"

          # í‘¸ì‹œ
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.check_fixes.outputs.has_fixes == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const branchName = '${{ steps.create_branch.outputs.branch_name }}';

            let reportContent = '';
            if (fs.existsSync('bug-hunt-report.md')) {
              reportContent = fs.readFileSync('bug-hunt-report.md', 'utf8');
              if (reportContent.length > 30000) {
                reportContent = reportContent.substring(0, 30000) + '\n\n... (ë‚´ìš©ì´ ì˜ë ¸ìŠµë‹ˆë‹¤)';
              }
            }

            let fixesContent = '';
            if (fs.existsSync('bug-fixes-applied.md')) {
              fixesContent = fs.readFileSync('bug-fixes-applied.md', 'utf8');
            }

            const bugCount = '${{ steps.check_report.outputs.bug_count }}';
            const highSeverity = '${{ steps.check_report.outputs.high_severity }}';
            const autoFixable = '${{ steps.check_report.outputs.auto_fixable }}';

            const title = `ğŸ¤– ìë™ ë²„ê·¸ ìˆ˜ì • (${autoFixable}ê°œ ìˆ˜ì • ì‹œë„)`;
            const body = `# ğŸ¤– ìë™ ë²„ê·¸ ìˆ˜ì • PR\n\n**ì‹¤í–‰ ì¼ì‹œ:** ${new Date().toISOString()}\n**ì›Œí¬í”Œë¡œìš°:** [Run #${{ github.run_id }}](../actions/runs/${{ github.run_id }})\n\n## ğŸ“Š ìš”ì•½\n\n- ë°œê²¬ëœ ì „ì²´ ë²„ê·¸: ${bugCount}ê°œ\n- ì‹¬ê°ë„ ë†’ìŒ: ${highSeverity}ê°œ\n- ìë™ ìˆ˜ì • ì‹œë„: ${autoFixable}ê°œ\n\n---\n\n## ğŸ”§ ì ìš©ëœ ìˆ˜ì •ì‚¬í•­\n\n${fixesContent || 'ìˆ˜ì • ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}\n\n---\n\n## ğŸ“‹ ì „ì²´ ë²„ê·¸ íƒìƒ‰ ë³´ê³ ì„œ\n\n<details>\n<summary>í¼ì³ë³´ê¸°</summary>\n\n${reportContent}\n\n</details>\n\n---\n\n## âš ï¸ ì¤‘ìš” ì•ˆë‚´\n\nì´ PRì€ **AIê°€ ìë™ìœ¼ë¡œ ìƒì„±**í•œ ë²„ê·¸ ìˆ˜ì •ì…ë‹ˆë‹¤.\n\n### ë¦¬ë·° ì‹œ í™•ì¸ì‚¬í•­:\n\n1. âœ… **ë¡œì§ ê²€ì¦**: ìˆ˜ì •ì´ ì˜ë„ëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸\n2. âœ… **í…ŒìŠ¤íŠ¸ ì‹¤í–‰**: ê´€ë ¨ í…ŒìŠ¤íŠ¸ê°€ ëª¨ë‘ í†µê³¼í•˜ëŠ”ì§€ í™•ì¸\n3. âœ… **ë¶€ì‘ìš© í™•ì¸**: ë‹¤ë¥¸ ë¶€ë¶„ì— ì˜í–¥ì´ ì—†ëŠ”ì§€ í™•ì¸\n4. âœ… **ë³´ì•ˆ ê²€í† **: ë³´ì•ˆ ê´€ë ¨ ìˆ˜ì •ì´ ì•ˆì „í•œì§€ í™•ì¸\n\n### ê¶Œì¥ ì¡°ì¹˜:\n\n- ğŸ§ª ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰: \`pnpm run test\`\n- ğŸ” ë³€ê²½ ì‚¬í•­ ìƒì„¸ ê²€í† \n- ğŸ’¬ ë¶ˆí™•ì‹¤í•œ ë¶€ë¶„ì€ ì½”ë©˜íŠ¸ë¡œ ì§ˆë¬¸\n- âŒ ë¬¸ì œê°€ ìˆìœ¼ë©´ ê±°ë¶€í•˜ê³  ìˆ˜ë™ ìˆ˜ì •\n\n**AI ìˆ˜ì •ì´ë¯€ë¡œ ë°˜ë“œì‹œ ë¦¬ë·° í›„ ë¨¸ì§€í•˜ì„¸ìš”!**`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              head: branchName,
              base: 'main',
              body: body
            });

            console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);

            // ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['automated', 'bug-fix', 'ai-generated', 'needs-review']
            });

            // ì‹¬ê°ë„ ë†’ì€ ë²„ê·¸ ìˆ˜ì •ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ priority-high ë¼ë²¨ ì¶”ê°€
            if (parseInt('${{ steps.check_report.outputs.high_severity }}') > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['priority-high']
              });
            }

      - name: Create issue for critical findings (no auto-fix)
        if: steps.check_report.outputs.high_severity != '0' && steps.check_fixes.outputs.has_fixes != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const bugCount = '${{ steps.check_report.outputs.bug_count }}';
            const highSeverity = '${{ steps.check_report.outputs.high_severity }}';

            let reportContent = 'ë³´ê³ ì„œë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            if (fs.existsSync('bug-hunt-report.md')) {
              reportContent = fs.readFileSync('bug-hunt-report.md', 'utf8');

              // ë„ˆë¬´ ê¸´ ê²½ìš° ìš”ì•½ë§Œ í¬í•¨
              if (reportContent.length > 60000) {
                const summaryEnd = reportContent.indexOf('## ğŸš¨ ì£¼ìš” ë°œê²¬ì‚¬í•­');
                const findingsEnd = reportContent.indexOf('## ğŸ’¡ ê¶Œì¥ì‚¬í•­');
                if (summaryEnd > 0 && findingsEnd > summaryEnd) {
                  reportContent = reportContent.substring(0, findingsEnd) +
                    '\n\n*ì „ì²´ ë³´ê³ ì„œëŠ” [Artifacts](../actions/runs/${{ github.run_id }})ë¥¼ í™•ì¸í•˜ì„¸ìš”.*';
                }
              }
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ› ìë™ ë²„ê·¸ íƒìƒ‰ ê²°ê³¼: ${highSeverity}ê°œì˜ ì‹¬ê°í•œ ë¬¸ì œ ë°œê²¬`,
              labels: ['bug', 'automated-scan', 'priority-high', 'needs-manual-fix'],
              body: `# ğŸ” ìë™ ë²„ê·¸ íƒìƒ‰ ë³´ê³ ì„œ

**ì‹¤í–‰ ì¼ì‹œ:** ${new Date().toISOString()}
**ì›Œí¬í”Œë¡œìš°:** [Run #${{ github.run_id }}](../actions/runs/${{ github.run_id }})

## ğŸ“Š ìš”ì•½

- ì´ ë°œê²¬ í•­ëª©: ${bugCount}ê°œ
- ğŸš¨ ì‹¬ê°ë„ ë†’ìŒ: ${highSeverity}ê°œ
- âš ï¸ ì¤‘ê°„/ë‚®ìŒ: ${bugCount - highSeverity}ê°œ
- ğŸ¤– ìë™ ìˆ˜ì • ë¶ˆê°€: ìˆ˜ë™ ìˆ˜ì • í•„ìš”

---

${reportContent}

---

**ìë™ ìƒì„±ëœ ì´ìŠˆì…ë‹ˆë‹¤.** ì´ ë²„ê·¸ë“¤ì€ ìë™ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ìˆ˜ë™ ì¡°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.
ìƒì„¸ ë‚´ìš©ì€ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ì˜ ì•„í‹°íŒ©íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
`
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Upload analysis reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: bug-hunt-reports
          path: |
            bug-hunt-report.md
            bug-fixes-applied.md
            fix-summary.md
            static-analysis-report.md
            problem-areas.md
            eslint-report.json
            typescript-errors.txt
            jscpd-report.json
          retention-days: 90

      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ› ìë™ ë²„ê·¸ íƒìƒ‰ ë° ìˆ˜ì • ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_report.outputs.report_exists }}" == "true" ]; then
            echo "### ğŸ“Š íƒìƒ‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "- ë°œê²¬ëœ í•­ëª©: ${{ steps.check_report.outputs.bug_count }}ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "- ì‹¬ê°ë„ ë†’ìŒ: ${{ steps.check_report.outputs.high_severity }}ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "- ìë™ ìˆ˜ì • ê°€ëŠ¥: ${{ steps.check_report.outputs.auto_fixable }}ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.check_fixes.outputs.has_fixes }}" == "true" ]; then
              echo "### ğŸ”§ ìë™ ìˆ˜ì •" >> $GITHUB_STEP_SUMMARY
              echo "âœ… ë²„ê·¸ ìˆ˜ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“‹ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ë·° í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.check_report.outputs.high_severity }}" -gt 0 ]; then
              echo "### âš ï¸ ìˆ˜ë™ ìˆ˜ì • í•„ìš”" >> $GITHUB_STEP_SUMMARY
              echo "ì‹¬ê°í•œ ë²„ê·¸ê°€ ë°œê²¬ë˜ì—ˆì§€ë§Œ ìë™ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
              echo "ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… ì‹¬ê°í•œ ë¬¸ì œëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ì•„í‹°íŒ©íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "ìƒì„¸ ë³´ê³ ì„œëŠ” [Artifacts](../actions/runs/${{ github.run_id }})ì—ì„œ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
