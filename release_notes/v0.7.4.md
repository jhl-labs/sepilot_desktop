# SEPilot Desktop v0.7.4 릴리스 노트

**릴리즈 날짜**: 2026-01-07

---

## 🐛 중요한 버그 수정

### 🚨 MCP 도구 호출 시 환각 데이터 문제 해결

MCP(Model Context Protocol)를 통한 도구 호출 시 LLM이 가짜/환각 데이터를 생성하는 심각한 문제를 수정했습니다.

**발견된 문제:**

1. **`isError` 플래그 무시**: MCP 도구가 에러를 반환해도 (`isError: true`) 이를 확인하지 않고 정상 결과처럼 LLM에게 전달
2. **빈 결과를 일반 텍스트로 대체**: "Tool returned no result", "Tool returned empty content" 같은 의미 없는 메시지를 전달하여 LLM이 실제 데이터로 착각
3. **에러 처리 지침 부족**: 시스템 프롬프트에 도구 실패 시 환각하지 말라는 명확한 지침이 없었음
4. **결과 검증 부재**: MCP 응답의 구조나 내용을 검증하지 않고 그대로 LLM에게 전달

**수정 내용:**

#### 1. MCP 도구 응답 검증 강화 (`lib/langgraph/nodes/tools.ts`)

```typescript
// ⚠️ CRITICAL: Check isError flag first to prevent hallucinations
if (mcpResult?.isError) {
  // MCP 도구가 에러를 반환한 경우 - 명확하게 에러로 표시
  const errorText =
    mcpResult.content
      ?.map((item: any) => item.text || '')
      .filter((text: string) => text)
      .join('\n') || 'Tool execution failed with unknown error';

  console.error(`[Tools] MCP tool returned error for ${call.name}:`, errorText);

  return {
    toolCallId: call.id,
    toolName: call.name,
    result: null,
    error: `Tool '${call.name}' failed: ${errorText}`,
  };
}
```

**주요 개선사항:**

- ✅ `isError` 플래그를 최우선으로 확인
- ✅ 에러 응답을 `error` 필드에 명확하게 표시
- ✅ null/undefined 응답 시 명확한 에러 메시지 제공
- ✅ 빈 content 배열 감지 및 에러 처리
- ✅ 빈 텍스트 결과 검증 추가

#### 2. LLM 시스템 프롬프트 개선 (`lib/langgraph/nodes/generate.ts`)

**추가된 에러 처리 지침:**

```markdown
## Critical: Handling Tool Errors

**⚠️ NEVER HALLUCINATE OR FABRICATE DATA WHEN A TOOL FAILS**

When you receive a tool error (marked with "Error:" in the result):

1. **Acknowledge the Error**: Tell the user that the tool operation failed
2. **Explain What Happened**: Clearly state which tool failed and why
3. **DO NOT Make Up Data**: Never invent, guess, or fabricate information
4. **Suggest Alternatives**: If possible, suggest alternative approaches
5. **Be Honest**: If you cannot complete the task without the tool, clearly state that

**Example of CORRECT error handling:**
❌ BAD: "I searched GitHub and found these repositories..." (when the search actually failed)
✅ GOOD: "The GitHub search tool failed with error: [error message]. I cannot provide search results without access to the GitHub API."

**Remember**: It's better to admit a tool failed than to provide false information.
```

**효과:**

- ✅ LLM에게 도구 실패 시 환각하지 말 것을 명확히 지시
- ✅ 올바른 에러 처리 예시 제공
- ✅ 거짓 정보보다 솔직한 실패 인정을 우선하도록 교육

---

## 🔧 기술적 개선

### MCP 에러 처리 흐름

**이전 (문제가 있던 흐름):**

```
MCP 도구 호출 → 에러 발생 → isError 플래그 무시 → 에러 메시지를 일반 텍스트로 전달
→ LLM이 에러 메시지를 실제 데이터로 착각 → 환각 데이터 생성
```

**현재 (수정된 흐름):**

```
MCP 도구 호출 → 에러 발생 → isError 플래그 확인 → error 필드에 명확히 표시
→ LLM이 에러임을 인식 → 사용자에게 솔직하게 실패 알림
```

### 추가된 검증 단계

1. **isError 플래그 검증**: 최우선 확인
2. **null/undefined 검증**: 응답이 없는 경우 명확한 에러
3. **빈 content 배열 검증**: 내용이 없는 응답 감지
4. **빈 텍스트 검증**: 공백만 있는 결과 필터링
5. **에러 로깅**: 모든 에러 상황을 콘솔에 기록

---

## 📊 영향 범위

**개선된 MCP 도구:**

- GitHub API 도구 (search_repositories, get_file_contents 등)
- 웹 검색 도구 (tavily_search 등)
- 파일 시스템 도구
- 브라우저 제어 도구
- 기타 모든 MCP 기반 외부 도구

**사용자 경험 개선:**

- ✅ 더 이상 존재하지 않는 저장소나 파일에 대한 가짜 정보를 받지 않음
- ✅ 도구 실패 시 명확한 에러 메시지 수신
- ✅ LLM이 실패를 솔직하게 인정하고 대안 제시
- ✅ 신뢰할 수 있는 정보만 제공받음

---

## 🧪 테스트 권장사항

수정된 코드를 검증하기 위해 다음 시나리오를 테스트하는 것을 권장합니다:

1. **존재하지 않는 GitHub 저장소 검색**: 이전에는 가짜 저장소 정보를 생성했으나, 이제는 "검색 실패" 메시지를 명확히 표시
2. **네트워크 오류 시나리오**: MCP 서버 연결 실패 시 명확한 에러 메시지
3. **빈 결과 반환**: 도구가 빈 결과를 반환할 때 환각 대신 솔직한 실패 인정
4. **타임아웃 시나리오**: 도구 호출이 시간 초과될 때 적절한 에러 처리

---

## 🛠 개발자 노트

### 코드 변경 위치

**수정된 파일:**

1. `lib/langgraph/nodes/tools.ts` (Line 610-683)
   - MCP 응답 처리 로직 전면 개선
   - isError 플래그 검증 추가
   - 다단계 검증 구현

2. `lib/langgraph/nodes/generate.ts` (Line 543-566)
   - 시스템 프롬프트에 에러 처리 지침 추가
   - 환각 방지 가이드라인 명시

### 코드 리뷰 시 주의사항

- `mcpResult?.isError` 확인은 **필수**입니다
- 빈 결과를 일반 텍스트로 대체하지 마세요
- 에러는 항상 `error` 필드에 명확히 표시해야 합니다
- 시스템 프롬프트에서 도구 실패 시 환각 금지를 명시해야 합니다

---

## 📝 관련 이슈

이 수정으로 다음과 같은 문제가 해결됩니다:

- MCP 도구 호출 시 가짜 데이터 응답
- GitHub API 실패 시 존재하지 않는 저장소 정보 생성
- 웹 검색 실패 시 허구의 검색 결과 제공
- 파일 읽기 실패 시 가상의 파일 내용 생성

---

## ✨ 새로운 기능

### Monaco Editor와 Coding Agent 통합 강화

Claude Desktop과 동등한 기능을 제공하기 위해 Monaco Editor의 텍스트 선택 기능이 Coding Agent와 완전히 통합되었습니다.

**추가된 기능:**

#### Monaco Editor Selection Change Listener (`extensions/editor/components/Editor.tsx`)

```typescript
// Monaco editor selection change listener
useEffect(() => {
  if (!editor || !monacoInstance) {
    return;
  }

  // Listen to cursor selection changes
  const disposable = editor.onDidChangeCursorSelection((e) => {
    const selection = e.selection;
    const model = editor.getModel();

    if (!model) {
      setActiveFileSelection(null);
      return;
    }

    // Check if there's a non-empty selection
    const hasSelection =
      !selection.isEmpty() &&
      (selection.startLineNumber !== selection.endLineNumber ||
        selection.startColumn !== selection.endColumn);

    if (hasSelection) {
      // Get selected text
      const selectedText = model.getValueInRange(selection);

      // Update store with selection info
      setActiveFileSelection({
        text: selectedText,
        range: {
          startLineNumber: selection.startLineNumber,
          startColumn: selection.startColumn,
          endLineNumber: selection.endLineNumber,
          endColumn: selection.endColumn,
        },
      });
    } else {
      // No selection - clear it
      setActiveFileSelection(null);
    }
  });

  // Cleanup listener on unmount
  return () => {
    disposable.dispose();
  };
}, [editor, monacoInstance, setActiveFileSelection]);
```

**주요 개선사항:**

- ✅ 에디터에서 텍스트를 선택하면 실시간으로 `activeFileSelection` 상태 업데이트
- ✅ 선택된 텍스트와 정확한 위치 정보(range) 저장
- ✅ Coding Agent가 사용자가 선택한 텍스트를 인식하고 활용 가능
- ✅ `replace_selection` 도구를 사용하여 선택된 텍스트 수정 가능
- ✅ Claude Desktop과 동일한 워크플로우 제공

**데이터 흐름:**

```
Monaco Editor 텍스트 선택
  → onDidChangeCursorSelection 이벤트
  → setActiveFileSelection (store 업데이트)
  → getGraphConfig (GraphConfig에 포함)
  → IPC를 통해 Coding Agent에 전달
  → Coding Agent가 선택된 텍스트 인식
  → replace_selection 도구로 텍스트 수정 가능
```

**사용자 경험 개선:**

- ✅ 에디터에서 코드를 선택하고 채팅으로 "이 부분을 개선해줘" 요청 가능
- ✅ Coding Agent가 정확히 선택된 부분만 수정
- ✅ 파일 전체가 아닌 특정 코드 블록에 대한 작업 가능
- ✅ Claude Desktop과 동일한 사용자 경험

**영향받는 파일:**

1. `extensions/editor/components/Editor.tsx`
   - `setActiveFileSelection` 추가
   - `onDidChangeCursorSelection` listener 구현

2. `lib/langgraph/graphs/coding-agent.ts`
   - 이미 `state.activeFileSelection` 처리 로직 구현됨 (Line 555-570, 822-839)

3. `lib/store/chat-store.ts`
   - `getGraphConfig()` 이미 `activeFileSelection` 포함 중

---

## ⚠️ Breaking Changes

없음. 이 수정은 내부 로직 개선이며 API 인터페이스는 변경되지 않았습니다.

---

**전체 변경 로그**: [v0.7.3...v0.7.4](https://github.com/jhl-labs/sepilot_desktop/compare/v0.7.3...v0.7.4)
