# SEPilot Desktop v0.6.3 릴리스 노트

## 주요 변경 사항

### 새로운 기능

- **DocumentList Repository 선택 UI 추가**
  - **탭 구조 단순화**: `[Personal] [Team Docs]` 두 개의 탭만 유지
  - **Repository 선택 드롭다운**: Team Docs 탭 선택 시 Repository를 선택할 수 있는 드롭다운 표시
  - **동적 필터링**: 선택된 Repository의 문서만 Tree View에 표시
  - **Push/Pull 버튼**: 선택된 Repository에 맞는 Push/Pull 버튼 표시
  - **명확한 구분**: 여러 Team Docs의 문서가 섞이지 않고 선택한 Repository만 표시
  - **필터링 로직 개선**: `filterByActiveTab` 함수로 `selectedTeamDocsId` 기준 필터링
  - 코드 위치: `components/rag/DocumentList.tsx:64-1186`

- **DocumentUploadDialog에 Team Docs Repository 선택 기능 추가**
  - **근본 원인 해결**: 문서 생성 시부터 올바른 `teamDocsId` 설정
  - **Team Docs 선택 UI**: 문서 그룹을 'team'으로 선택 시 Repository 선택 드롭다운 표시
  - **자동 메타데이터 설정**: 선택한 Team Docs의 `teamDocsId`, `teamName`, `source` 자동 포함
  - **검증 로직**: Team Docs 선택하지 않으면 업로드 차단
  - **사용자 안내**: Team Docs 미설정 시 경고 메시지 표시
  - 코드 위치: `components/rag/DocumentUploadDialog.tsx:59-324`

- **Markdown 파일에서 클립보드 이미지 붙여넣기 기능**
  - **Ctrl+V로 이미지 삽입**: Markdown 파일 편집 중 스크린샷이나 캡처한 이미지를 즉시 붙여넣기 가능
  - **자동 저장**: 클립보드 이미지를 working directory에 자동 저장 (image-{timestamp}.png)
  - **Markdown 문법 자동 삽입**: 이미지가 저장되면 `![filename](./filename)` 형식으로 커서 위치에 자동 삽입
  - **Working Directory 기준 상대 경로**: 현재 Markdown 파일이 아닌 working directory 기준으로 경로 계산 (깔끔하고 이식성 높은 경로)
  - **크로스 플랫폼 경로**: Windows 백슬래시를 forward slash로 정규화
  - **IPC 기반 경로 계산**: path-browserify 신뢰성 문제 해결 - 모든 경로 연산을 서버측에서 처리
  - **미리보기 렌더링**: MarkdownRenderer가 IPC를 통해 로컬 이미지를 base64 data URL로 변환
  - **보안 샌드박스 준수**: file:// 프로토콜 대신 IPC를 통한 안전한 파일 접근
  - **Monaco Editor 통합**: Monaco의 command API를 사용하여 안정적인 paste 이벤트 처리
  - **네이티브 클립보드 지원**: Electron clipboard API 사용으로 안정적인 이미지 감지
  - **편리한 워크플로우**: 스크린샷 → Ctrl+V → 즉시 문서에 삽입 및 미리보기
  - 코드 위치:
    - IPC 핸들러: `electron/ipc/handlers/file.ts:712-824`
    - 클라이언트: `components/editor/Editor.tsx:857-895`
    - 렌더러: `components/markdown/MarkdownRenderer.tsx:163-190`

### 버그 수정 및 UX 개선

- **Team Docs Push githubPath 생성 로직 수정**
  - **문제**: githubPath가 undefined여서 404 에러 발생
  - **원인**: `config.docsPath`만 사용하고 문서의 `folderPath`를 무시
  - **해결**: `folderPath` 우선 사용하여 githubPath 생성
  - **우선순위**: `metadata.githubPath` > `metadata.folderPath` > `config.docsPath` > `'documents'`
  - **디버그 로그**: push 전 githubPath 정보 출력
  - 코드 위치: `electron/ipc/handlers/team-docs.ts:475-488`

- **Team Docs Push 에러 방지 및 UX 개선**
  - **UI 개선**: `teamDocsId`가 없는 경우 "저장 & Push" 버튼 비활성화
  - **시각적 피드백**: 비활성화된 버튼에 경고 아이콘 표시
  - **명확한 설명**: Tooltip으로 Push 불가 이유 설명
    - "Team Docs ID가 없어 GitHub Push를 할 수 없습니다."
    - "이 문서는 Team Docs에서 가져온 문서가 아닙니다."
  - **이중 안전장치**: 버튼 비활성화 + 백엔드 검증으로 에러 방지
  - 코드 위치:
    - UI 개선: `components/rag/DocumentEditDialog.tsx:477-520`
    - 백엔드 검증: `components/rag/DocumentEditDialog.tsx:219-226`

- **파일명 변경 시 이전 파일 자동 삭제**
  - **문제**: 문서 제목이나 폴더 경로 변경 시 GitHub에 새 파일 생성되지만 이전 파일은 남아있음
  - **해결**: 파일명 변경 감지 시 이전 파일을 자동으로 삭제
  - **구현**:
    - `oldGithubPath` 파라미터 추가: 파일명 변경 감지용
    - GitHub API `deleteFile` 메서드: 이전 파일 삭제 기능
    - 자동 감지: `oldGithubPath !== githubPath` 시 삭제 수행
    - 안전 처리: 삭제 실패 시 경고만 출력하고 Push는 계속 진행
  - **워크플로우**:
    1. 사용자가 문서 제목 또는 폴더 경로 변경
    2. 새 `githubPath` 자동 생성
    3. 이전 파일 삭제 요청 (GitHub API)
    4. 새 경로에 문서 생성 (`sha: undefined`로 새 파일 처리)
  - 코드 위치:
    - GitHub 클라이언트: `lib/github/client.ts:164-207`
    - 프론트엔드: `components/rag/DocumentEditDialog.tsx:232-257`
    - 백엔드 핸들러: `electron/ipc/handlers/team-docs.ts:299-381`
    - 타입 정의: `types/electron.d.ts:619`

- **DocumentList 빈 상태 메시지 정확성 개선**
  - **문제**: Team Docs가 설정되어 있지만 선택된 Repository에 문서가 없을 때도 "등록된 Team Docs가 없습니다" 메시지 표시
  - **혼란 지점**: Repository 선택 UI는 표시되는데 메시지는 "등록이 없다"고 표시되어 사용자 혼란
  - **해결**: 상황에 따라 다른 메시지 표시
    - Team Docs 설정 없음: "등록된 Team Docs가 없습니다. Settings에서 추가하세요."
    - Repository에 문서 없음: "선택한 Repository (이름)에 문서가 없습니다. Pull을 통해 동기화하거나 새 문서를 업로드하세요."
  - **사용자 경험**: 상황에 맞는 명확한 안내로 다음 행동 가이드
  - 코드 위치: `components/rag/DocumentList.tsx:1358-1386`

- **DocumentUploadDialog 업로드 버튼 비활성화 로직 추가**
  - **문제**: Team Docs 선택 시 설정된 Repository가 없어도 업로드 버튼 활성화
  - **기존 동작**: 사용자가 클릭 → 에러 메시지 표시
  - **개선**: Team Docs 선택 시 Repository가 없으면 업로드 버튼 비활성화
  - **사용자 경험**:
    - 경고 메시지로 이유 설명
    - 버튼 비활성화로 실수 방지
    - 에러 없이 명확한 상태 전달
  - 코드 위치: `components/rag/DocumentUploadDialog.tsx:639`

## 기술적 세부 사항

### 에러 발생 근본 원인

#### 1. DocumentList Repository 구분 문제

**기존 구조**:

- 단순히 `[Personal] [Team]` 두 개의 탭만 존재
- Team 탭에서 **모든 Team Docs의 문서가 섞여서 표시**
- 필터링: `docGroup === 'team'`만 확인, `teamDocsId` 구분 안함
- Repository 선택 UI 없음
- 결과: 여러 Team Docs의 문서가 하나의 tree에 혼재

**문제점**:

- 사용자가 어떤 Team Docs의 문서인지 구분 불가
- Repository를 선택할 방법이 없음
- 특정 Team Docs의 문서만 보고 싶어도 불가능

#### 2. DocumentUploadDialog 메타데이터 누락

DocumentUploadDialog에서 `docGroup: 'team'`을 선택하면:

- **문제**: `teamDocsId` 없이 문서가 생성됨
- **결과**: 해당 문서는 Team Docs로 Push 불가능
- **에러**: "Team Docs 설정을 찾을 수 없습니다: undefined"

기존에는:

1. 사용자가 DocumentUploadDialog에서 Team Docs 선택
2. `docGroup: 'team'`만 설정되고 `teamDocsId`는 누락
3. DocumentEditDialog에서 "저장 & Push" 시도
4. `teamDocsId: undefined` 전달 → 에러 발생

### 해결 방법

#### 1. DocumentList Repository 선택 UI 추가

- **탭 구조 유지**:

  ```typescript
  const [activeTab, setActiveTab] = useState<'personal' | 'team'>('personal');
  // Personal / Team Docs 두 개의 탭만 유지
  ```

- **Repository 선택 state 추가**:

  ```typescript
  const [selectedTeamDocsId, setSelectedTeamDocsId] = useState<string>('');
  // 선택된 Team Docs ID 관리
  ```

- **Repository 선택 드롭다운**:

  ```typescript
  {
    activeTab === 'team' &&
      teamDocs.length > 0 && (
        <select value={selectedTeamDocsId} onChange={(e) => setSelectedTeamDocsId(e.target.value)}>
          {teamDocs.map((team) => (
            <option value={team.id}>
              {team.name} ({team.owner}/{team.repo})
            </option>
          ))}
        </select>
      );
  }
  ```

- **필터링 로직 개선**:

  ```typescript
  const filterByActiveTab = (docs) => {
    if (activeTab === 'personal') {
      return docs.filter((doc) => doc.metadata?.docGroup === 'personal');
    } else {
      // 선택된 Team Docs만 필터링
      return docs.filter((doc) => doc.metadata?.teamDocsId === selectedTeamDocsId);
    }
  };
  ```

- **Push/Pull 버튼**:
  - 선택된 Repository의 Push/Pull 버튼만 표시
  - `selectedTeamDocsId` 기준으로 동작

#### 2. DocumentUploadDialog 개선

- **Team Docs Repository 선택 UI 추가**:
  - `docGroup: 'team'` 선택 시 Repository 드롭다운 표시
  - 사용자가 명시적으로 어떤 Team Docs인지 선택
- **자동 메타데이터 설정**:
  - `teamDocsId`: 선택한 Team Docs ID
  - `teamName`: Team Docs 이름
  - `source`: `{owner}/{repo}` 형식
- **검증 로직**:
  - Team Docs 선택하지 않으면 업로드 차단
  - Team Docs 미설정 시 경고 메시지 표시

#### 3. DocumentEditDialog 개선 (증상 완화)

- **프론트엔드 (1차 방어)**:
  - `teamDocsId` 없으면 "저장 & Push" 버튼 비활성화
  - Tooltip으로 상태 및 이유 설명
  - AlertCircle 아이콘으로 시각적 피드백
- **백엔드 (2차 방어)**:
  - Push 요청 전 `teamDocsId` 존재 여부 검증
  - 검증 실패 시 Push 중단 및 명확한 에러 메시지 표시

### UI/UX 개선 효과

- **간단한 탭 구조**: Personal / Team Docs 두 개의 탭만으로 단순화
- **명확한 Repository 선택**: 드롭다운으로 원하는 Team Docs Repository 선택
- **독립적인 Tree View**: 선택한 Repository의 문서만 표시
- **효율적 관리**: 선택한 Repository에 대해서만 Push/Pull 가능
- **근본 해결**: 처음부터 올바른 메타데이터로 문서 생성
- **사용자 가이드**: 어떤 Team Docs에 속할지 명확히 선택
- **에러 방지**: 잘못된 상태의 문서가 생성되지 않음
- **직관적 UI**: 혼란스러운 에러 대신 사전 안내

## 영향 범위

- **DocumentList (개선)**: Repository 선택 드롭다운, 필터링 로직, Push/Pull UI
- **DocumentUploadDialog (신규)**: Team Docs Repository 선택 기능
- **DocumentEditDialog (개선)**: Push 버튼 검증 및 비활성화
- **전반적 효과**: Team Docs 사용성 및 안정성 대폭 향상
