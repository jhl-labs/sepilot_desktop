# SEPilot Desktop v0.6.3 릴리스 노트

## 주요 변경 사항

### 새로운 기능

- **DocumentList Repository 선택 UI 추가**
  - **탭 구조 단순화**: `[Personal] [Team Docs]` 두 개의 탭만 유지
  - **Repository 선택 드롭다운**: Team Docs 탭 선택 시 Repository를 선택할 수 있는 드롭다운 표시
  - **동적 필터링**: 선택된 Repository의 문서만 Tree View에 표시
  - **Push/Pull 버튼**: 선택된 Repository에 맞는 Push/Pull 버튼 표시
  - **명확한 구분**: 여러 Team Docs의 문서가 섞이지 않고 선택한 Repository만 표시
  - **필터링 로직 개선**: `filterByActiveTab` 함수로 `selectedTeamDocsId` 기준 필터링
  - 코드 위치: `components/rag/DocumentList.tsx:64-1186`

- **DocumentUploadDialog에 Team Docs Repository 선택 기능 추가**
  - **근본 원인 해결**: 문서 생성 시부터 올바른 `teamDocsId` 설정
  - **Team Docs 선택 UI**: 문서 그룹을 'team'으로 선택 시 Repository 선택 드롭다운 표시
  - **자동 메타데이터 설정**: 선택한 Team Docs의 `teamDocsId`, `teamName`, `source` 자동 포함
  - **검증 로직**: Team Docs 선택하지 않으면 업로드 차단
  - **사용자 안내**: Team Docs 미설정 시 경고 메시지 표시
  - 코드 위치: `components/rag/DocumentUploadDialog.tsx:59-324`

- **Markdown 파일에서 클립보드 이미지 붙여넣기 기능**
  - **Ctrl+V로 이미지 삽입**: Markdown 파일 편집 중 스크린샷이나 캡처한 이미지를 즉시 붙여넣기 가능
  - **자동 저장**: 클립보드 이미지를 working directory에 자동 저장 (image-{timestamp}.png)
  - **Markdown 문법 자동 삽입**: 이미지가 저장되면 `![filename](./filename)` 형식으로 커서 위치에 자동 삽입
  - **Working Directory 기준 상대 경로**: 현재 Markdown 파일이 아닌 working directory 기준으로 경로 계산 (깔끔하고 이식성 높은 경로)
  - **크로스 플랫폼 경로**: Windows 백슬래시를 forward slash로 정규화
  - **IPC 기반 경로 계산**: path-browserify 신뢰성 문제 해결 - 모든 경로 연산을 서버측에서 처리
  - **미리보기 렌더링**: MarkdownRenderer가 IPC를 통해 로컬 이미지를 base64 data URL로 변환
  - **보안 샌드박스 준수**: file:// 프로토콜 대신 IPC를 통한 안전한 파일 접근
  - **Monaco Editor 통합**: Monaco의 command API를 사용하여 안정적인 paste 이벤트 처리
  - **네이티브 클립보드 지원**: Electron clipboard API 사용으로 안정적인 이미지 감지
  - **편리한 워크플로우**: 스크린샷 → Ctrl+V → 즉시 문서에 삽입 및 미리보기
  - 코드 위치:
    - IPC 핸들러: `electron/ipc/handlers/file.ts:712-824`
    - 클라이언트: `components/editor/Editor.tsx:857-895`
    - 렌더러: `components/markdown/MarkdownRenderer.tsx:163-190`

- **FileExplorer 드래그앤드랍 기능 추가**
  - **VSCode 스타일 파일/폴더 이동**: 파일 트리에서 파일이나 폴더를 드래그하여 다른 폴더로 이동 가능
  - **복사 기능**: Ctrl(Windows/Linux) 또는 Cmd(Mac) 키를 누른 채 드래그하면 이동 대신 복사 수행
  - **안전한 이동 방지**:
    - 파일/폴더를 자기 자신에게 드랍 불가
    - 상위 폴더를 하위 폴더로 이동 불가 (순환 참조 방지)
    - 디렉토리에만 드랍 가능 (파일에는 드랍 불가)
  - **시각적 피드백**: 드랍 가능한 디렉토리 위로 드래그 시 파란색 테두리로 표시
  - **작업 구분 표시**: 마우스 커서 아이콘으로 이동/복사 작업 구분
  - **편리한 파일 관리**: 컨텍스트 메뉴 없이 직관적으로 파일/폴더 정리 가능
  - **폴더 확장 상태 유지**: 파일 작업 후 새로고침 시에도 열려있던 폴더들이 그대로 유지
  - 코드 위치: `components/layout/FileTreeItem.tsx:233-363`

- **파일 트리 폴더 확장 상태 유지**
  - **문제**: 드래그앤드랍이나 파일 작업 후 새로고침 시 열려있던 폴더들이 모두 닫힘
  - **해결**: Zustand store에 확장된 폴더 경로들을 전역 상태로 저장
  - **기능**:
    - `expandedFolderPaths: Set<string>`: 확장된 폴더 경로 저장
    - `toggleExpandedFolder(path)`: 폴더 확장/축소 토글
    - `clearExpandedFolders()`: 모든 확장 상태 초기화
  - **효과**:
    - 파일 작업 후에도 폴더 확장 상태 유지
    - working directory 변경 시에만 초기화
    - 더 나은 사용자 경험
  - 코드 위치:
    - Store: `lib/store/chat-store.ts:179,469,1814-1828`
    - 컴포넌트: `components/layout/FileTreeItem.tsx:58-61,63-80`

### 버그 수정 및 UX 개선

- **드래그앤드랍 Windows 경로 처리 수정**
  - **문제**: Windows 경로(`C:\Users\...`)에서 path-browserify가 파일명 추출 실패
  - **증상**: 대상 경로가 `C:\Users\...\Projects\C:\Users\...` 처럼 중복 생성되어 "ENOENT" 에러 발생
  - **해결**:
    - dataTransfer에 파일명(`node.name`) 직접 저장하여 path-browserify 의존성 제거
    - IPC `resolvePath` API로 서버측에서 안전하게 경로 결합
    - 경로 비교 시 백슬래시(`\`)를 슬래시(`/`)로 정규화하여 크로스 플랫폼 지원
  - **효과**: Windows, macOS, Linux 모두에서 드래그앤드랍 정상 작동
  - 코드 위치: `components/layout/FileTreeItem.tsx:233-370`

- **폴더 확장 상태 유지 자동 로딩 수정**
  - **문제**: `expandedFolderPaths`에 경로가 저장되지만 children 데이터가 없어서 빈 폴더로 표시됨
  - **원인**: 새로고침 시 `node.children`이 undefined이면 아무것도 렌더링되지 않음
  - **해결**:
    - useEffect로 `isExpanded && !children` 조건 시 자동으로 children 로딩
    - `node.children` 변경 시 local state 동기화
    - 확장된 폴더는 새로고침 후 자동으로 내용 로드
  - **효과**: 드래그앤드랍/파일 작업 후 폴더 확장 상태와 내용이 완전히 유지됨
  - 코드 위치: `components/layout/FileTreeItem.tsx:63-78`

- **파일/폴더 이름 변경 Input 입력 불가 문제 수정**
  - **문제**: 이름 변경 시 Input에 포커스가 가지 않고 입력이 전혀 되지 않음
  - **원인**: Input이 `FileTreeContextMenu` 컴포넌트 내부에 있어서 ContextMenuTrigger가 이벤트 차단
  - **해결**:
    - `isRenaming`일 때는 ContextMenu를 렌더링하지 않음
    - Input을 ContextMenu 밖으로 완전히 분리
    - 조건부 렌더링으로 독립적으로 처리
  - **효과**: 이름 변경 시 Input에 정상적으로 포커스되고 입력 가능
  - 코드 위치: `components/layout/FileTreeItem.tsx:383-447`

- **파일/폴더 이름 변경 시 파일 삭제 버그 수정**
  - **문제**: 이름 변경 시도 시 파일이 삭제되거나 사라지는 심각한 버그 발생
  - **원인**:
    - `path-browserify`가 Windows 경로를 잘못 처리
    - `path.dirname()`과 `path.join()`이 부정확한 경로 생성
    - 잘못된 경로로 rename 시도하여 파일 손실
  - **해결**:
    - `path-browserify` import 완전히 제거
    - `parentPath` props를 사용하여 부모 디렉토리 경로 활용
    - IPC `resolvePath` API로 서버측에서 안전하게 새 경로 생성
    - `newName.trim()`으로 공백 제거 및 유효성 검증 강화
    - `handleOpenInTerminal`도 `parentPath` 사용하도록 수정
  - **효과**:
    - 안전하고 정확한 이름 변경
    - Windows, macOS, Linux 모두에서 정상 작동
    - 파일 삭제/손실 버그 완전히 해결
  - 코드 위치: `components/layout/FileTreeItem.tsx:116-167`

- **FileExplorer 파일/폴더 생성 경로 처리 개선**
  - **문제**: `handleCreateItem`에서 `path.join()` 사용으로 Windows 경로 처리 불안정
  - **해결**:
    - `path-browserify` import 제거
    - IPC `resolvePath` API로 경로 생성
    - `newItemName.trim()`으로 공백 제거
    - API 가용성 검증 추가
  - **효과**: FileTreeItem과 동일한 안전한 경로 처리 적용
  - 코드 위치: `components/layout/FileExplorer.tsx:133-170`

- **경로 복사 기능 간소화 및 개선**
  - **문제**: `handleCopyPath`에서 불필요하게 `getAbsolutePath` API 호출
  - **원인**: `node.path`는 이미 절대 경로인데 한 번 더 변환 시도
  - **해결**:
    - `node.path`를 바로 클립보드에 복사
    - 불필요한 IPC 호출 제거
    - 간단하고 명확한 로직
  - **효과**:
    - 빠르고 안정적인 경로 복사
    - 에러 발생 가능성 감소
    - 코드 단순화
  - 코드 위치: `components/layout/FileTreeItem.tsx:183-191`

- **Team Docs Push githubPath 생성 로직 수정**
  - **문제**: githubPath가 undefined여서 404 에러 발생
  - **원인**: `config.docsPath`만 사용하고 문서의 `folderPath`를 무시
  - **해결**: `folderPath` 우선 사용하여 githubPath 생성
  - **우선순위**: `metadata.githubPath` > `metadata.folderPath` > `config.docsPath` > `'documents'`
  - **디버그 로그**: push 전 githubPath 정보 출력
  - 코드 위치: `electron/ipc/handlers/team-docs.ts:475-488`

- **Team Docs Push 에러 방지 및 UX 개선**
  - **UI 개선**: `teamDocsId`가 없는 경우 "저장 & Push" 버튼 비활성화
  - **시각적 피드백**: 비활성화된 버튼에 경고 아이콘 표시
  - **명확한 설명**: Tooltip으로 Push 불가 이유 설명
    - "Team Docs ID가 없어 GitHub Push를 할 수 없습니다."
    - "이 문서는 Team Docs에서 가져온 문서가 아닙니다."
  - **이중 안전장치**: 버튼 비활성화 + 백엔드 검증으로 에러 방지
  - 코드 위치:
    - UI 개선: `components/rag/DocumentEditDialog.tsx:477-520`
    - 백엔드 검증: `components/rag/DocumentEditDialog.tsx:219-226`

- **파일명 변경 시 이전 파일 자동 삭제**
  - **문제**: 문서 제목이나 폴더 경로 변경 시 GitHub에 새 파일 생성되지만 이전 파일은 남아있음
  - **해결**: 파일명 변경 감지 시 이전 파일을 자동으로 삭제
  - **구현**:
    - `oldGithubPath` 파라미터 추가: 파일명 변경 감지용
    - GitHub API `deleteFile` 메서드: 이전 파일 삭제 기능
    - 자동 감지: `oldGithubPath !== githubPath` 시 삭제 수행
    - 안전 처리: 삭제 실패 시 경고만 출력하고 Push는 계속 진행
  - **워크플로우**:
    1. 사용자가 문서 제목 또는 폴더 경로 변경
    2. 새 `githubPath` 자동 생성
    3. 이전 파일 삭제 요청 (GitHub API)
    4. 새 경로에 문서 생성 (`sha: undefined`로 새 파일 처리)
  - 코드 위치:
    - GitHub 클라이언트: `lib/github/client.ts:164-207`
    - 프론트엔드: `components/rag/DocumentEditDialog.tsx:232-257`
    - 백엔드 핸들러: `electron/ipc/handlers/team-docs.ts:299-381`
    - 타입 정의: `types/electron.d.ts:619`

- **DocumentList 빈 상태 메시지 정확성 개선**
  - **문제**: Team Docs가 설정되어 있지만 선택된 Repository에 문서가 없을 때도 "등록된 Team Docs가 없습니다" 메시지 표시
  - **혼란 지점**: Repository 선택 UI는 표시되는데 메시지는 "등록이 없다"고 표시되어 사용자 혼란
  - **해결**: 상황에 따라 다른 메시지 표시
    - Team Docs 설정 없음: "등록된 Team Docs가 없습니다. Settings에서 추가하세요."
    - Repository에 문서 없음: "선택한 Repository (이름)에 문서가 없습니다. Pull을 통해 동기화하거나 새 문서를 업로드하세요."
  - **사용자 경험**: 상황에 맞는 명확한 안내로 다음 행동 가이드
  - 코드 위치: `components/rag/DocumentList.tsx:1358-1386`

- **DocumentUploadDialog 업로드 버튼 비활성화 로직 추가**
  - **문제**: Team Docs 선택 시 설정된 Repository가 없어도 업로드 버튼 활성화
  - **기존 동작**: 사용자가 클릭 → 에러 메시지 표시
  - **개선**: Team Docs 선택 시 Repository가 없으면 업로드 버튼 비활성화
  - **사용자 경험**:
    - 경고 메시지로 이유 설명
    - 버튼 비활성화로 실수 방지
    - 에러 없이 명확한 상태 전달
  - 코드 위치: `components/rag/DocumentUploadDialog.tsx:639`

## 기술적 세부 사항

### 에러 발생 근본 원인

#### 1. DocumentList Repository 구분 문제

**기존 구조**:

- 단순히 `[Personal] [Team]` 두 개의 탭만 존재
- Team 탭에서 **모든 Team Docs의 문서가 섞여서 표시**
- 필터링: `docGroup === 'team'`만 확인, `teamDocsId` 구분 안함
- Repository 선택 UI 없음
- 결과: 여러 Team Docs의 문서가 하나의 tree에 혼재

**문제점**:

- 사용자가 어떤 Team Docs의 문서인지 구분 불가
- Repository를 선택할 방법이 없음
- 특정 Team Docs의 문서만 보고 싶어도 불가능

#### 2. DocumentUploadDialog 메타데이터 누락

DocumentUploadDialog에서 `docGroup: 'team'`을 선택하면:

- **문제**: `teamDocsId` 없이 문서가 생성됨
- **결과**: 해당 문서는 Team Docs로 Push 불가능
- **에러**: "Team Docs 설정을 찾을 수 없습니다: undefined"

기존에는:

1. 사용자가 DocumentUploadDialog에서 Team Docs 선택
2. `docGroup: 'team'`만 설정되고 `teamDocsId`는 누락
3. DocumentEditDialog에서 "저장 & Push" 시도
4. `teamDocsId: undefined` 전달 → 에러 발생

### 해결 방법

#### 1. DocumentList Repository 선택 UI 추가

- **탭 구조 유지**:

  ```typescript
  const [activeTab, setActiveTab] = useState<'personal' | 'team'>('personal');
  // Personal / Team Docs 두 개의 탭만 유지
  ```

- **Repository 선택 state 추가**:

  ```typescript
  const [selectedTeamDocsId, setSelectedTeamDocsId] = useState<string>('');
  // 선택된 Team Docs ID 관리
  ```

- **Repository 선택 드롭다운**:

  ```typescript
  {
    activeTab === 'team' &&
      teamDocs.length > 0 && (
        <select value={selectedTeamDocsId} onChange={(e) => setSelectedTeamDocsId(e.target.value)}>
          {teamDocs.map((team) => (
            <option value={team.id}>
              {team.name} ({team.owner}/{team.repo})
            </option>
          ))}
        </select>
      );
  }
  ```

- **필터링 로직 개선**:

  ```typescript
  const filterByActiveTab = (docs) => {
    if (activeTab === 'personal') {
      return docs.filter((doc) => doc.metadata?.docGroup === 'personal');
    } else {
      // 선택된 Team Docs만 필터링
      return docs.filter((doc) => doc.metadata?.teamDocsId === selectedTeamDocsId);
    }
  };
  ```

- **Push/Pull 버튼**:
  - 선택된 Repository의 Push/Pull 버튼만 표시
  - `selectedTeamDocsId` 기준으로 동작

#### 2. DocumentUploadDialog 개선

- **Team Docs Repository 선택 UI 추가**:
  - `docGroup: 'team'` 선택 시 Repository 드롭다운 표시
  - 사용자가 명시적으로 어떤 Team Docs인지 선택
- **자동 메타데이터 설정**:
  - `teamDocsId`: 선택한 Team Docs ID
  - `teamName`: Team Docs 이름
  - `source`: `{owner}/{repo}` 형식
- **검증 로직**:
  - Team Docs 선택하지 않으면 업로드 차단
  - Team Docs 미설정 시 경고 메시지 표시

#### 3. DocumentEditDialog 개선 (증상 완화)

- **프론트엔드 (1차 방어)**:
  - `teamDocsId` 없으면 "저장 & Push" 버튼 비활성화
  - Tooltip으로 상태 및 이유 설명
  - AlertCircle 아이콘으로 시각적 피드백
- **백엔드 (2차 방어)**:
  - Push 요청 전 `teamDocsId` 존재 여부 검증
  - 검증 실패 시 Push 중단 및 명확한 에러 메시지 표시

### UI/UX 개선 효과

- **간단한 탭 구조**: Personal / Team Docs 두 개의 탭만으로 단순화
- **명확한 Repository 선택**: 드롭다운으로 원하는 Team Docs Repository 선택
- **독립적인 Tree View**: 선택한 Repository의 문서만 표시
- **효율적 관리**: 선택한 Repository에 대해서만 Push/Pull 가능
- **근본 해결**: 처음부터 올바른 메타데이터로 문서 생성
- **사용자 가이드**: 어떤 Team Docs에 속할지 명확히 선택
- **에러 방지**: 잘못된 상태의 문서가 생성되지 않음
- **직관적 UI**: 혼란스러운 에러 대신 사전 안내

## 영향 범위

- **DocumentList (개선)**: Repository 선택 드롭다운, 필터링 로직, Push/Pull UI
- **DocumentUploadDialog (신규)**: Team Docs Repository 선택 기능
- **DocumentEditDialog (개선)**: Push 버튼 검증 및 비활성화
- **전반적 효과**: Team Docs 사용성 및 안정성 대폭 향상
