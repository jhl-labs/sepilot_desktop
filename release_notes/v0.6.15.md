# SEPilot Desktop v0.6.15 릴리즈 노트

**릴리즈 날짜**: 2025-01-15

## 🎯 주요 개선사항

### 프록시 환경 안정성 대폭 향상

프록시 설정 관련 두 가지 핵심 문제를 해결하여 프록시 환경에서의 안정성이 크게 향상되었습니다.

## 🐛 버그 수정

### 1. 프록시 비활성화 시 환경 변수 무시 처리 추가 (b688f6f)

**문제**:

- 프록시 설정을 "사용 안함"으로 했음에도 불구하고 `HTTPS_PROXY`, `HTTP_PROXY` 환경 변수가 여전히 적용됨
- 사용자가 명시적으로 프록시를 비활성화했는데도 환경 변수로 인해 프록시가 사용되어 연결 실패 발생

**영향**:

- 모델 목록 가져오기 실패
- LLM API 호출 실패
- 모든 HTTP 통신에서 의도하지 않은 프록시 사용

**수정 내역**:

**lib/http/agent-factory.ts**:

- `createNoProxyAgent()` 함수 추가: 프록시 비활성화 시 명시적으로 HTTPS agent 생성
- 프록시 설정이 `enabled: false` 또는 `mode: 'none'`일 때 환경 변수를 무시하는 agent 사용

**lib/http/fetch.ts**:

- `shouldIgnoreEnvProxy` 플래그 계산: 프록시 비활성화 여부 판단
- fetch 실행 전 환경 변수 임시 제거: `HTTP_PROXY`, `HTTPS_PROXY`, `http_proxy`, `https_proxy` 삭제
- `finally` 블록에서 환경 변수 복원하여 부작용 방지

**작동 원리**:
프록시 설정을 "사용 안함"으로 했을 때:

1. **Agent 레벨**: `createNoProxyAgent()`로 명시적인 HTTPS agent 생성 → 환경 변수 fallback 방지
2. **Fetch 레벨**: 환경 변수 임시 제거 → fetch 실행 → 환경 변수 복원

이중 방어로 환경 변수가 절대 영향을 주지 않도록 보장합니다.

### 2. 프록시 환경에서 JSON 파싱 에러 감지 향상 (b9a30ac, 48825a7)

**문제**:

- 프록시 서버가 HTML 에러 페이지를 반환할 때 `JSON.parse()`가 `SyntaxError` 발생
- 에러 메시지가 "알 수 없는 오류가 발생했습니다. ({{code}})" 형태로 템플릿 미치환
- 실제 에러 원인 파악 어려움

**영향**:

- 프록시 인증 실패 (407)
- 프록시 연결 실패 (502, 503)
- 프록시 설정 오류 시 불명확한 에러 메시지

**수정 내역**:

**lib/http/fetch.ts**:

- `safeJsonParse()` 헬퍼 함수 추가:
  - Content-Type 헤더 검증
  - HTML 응답 감지 (`<!DOCTYPE`, `<html` 태그)
  - 빈 응답 감지
  - 명확한 한국어 에러 메시지 제공
  - 응답 미리보기 포함 (처음 200자)

**적용 범위**:

- `lib/llm/providers/openai.ts`: `getModels()` 메서드
- `lib/llm/providers/ollama.ts`: `chat()`, `getModels()` 메서드
- `components/settings/settingsUtils.ts`: `fetchAvailableModels()`
- `components/rag/VectorDBSettings.tsx`: 임베딩 모델 조회
- `components/settings/GeneralSettingsTab.tsx`: GitHub Release 정보 조회
- `electron/ipc/handlers/auth.ts`: OAuth 토큰 교환
- `electron/ipc/handlers/llm.ts`: LLM 모델 목록 조회

**개선된 에러 메시지**:

```
❌ 기존: "알 수 없는 오류가 발생했습니다. ({{code}})"
✅ 개선: "서버가 HTML 페이지를 반환했습니다 (HTTP 407, URL: https://api.openai.com/v1/models).
         프록시 설정이나 네트워크 연결을 확인해주세요.
         예상: JSON 응답, 실제: HTML 페이지"
```

## 📊 적용 범위

### ✅ 완벽 적용된 기능

이번 릴리즈로 다음 기능들의 프록시 환경 안정성이 향상되었습니다:

- **LLM 통신**: OpenAI, Ollama (모델 조회, 채팅)
- **Settings UI**: 모든 연결 테스트 및 모델 조회
- **Embeddings**: 임베딩 모델 조회
- **GitHub 통합**: Release 정보 조회, OAuth 인증
- **모든 HTTP 통신**: 프록시 비활성화 설정 완벽 적용

## 🔍 검증

### 정적 분석

- ✅ eslint: 통과
- ✅ TypeScript type-check: 통과

### 테스트 시나리오

1. **프록시 비활성화 테스트**:
   - 환경 변수 `HTTPS_PROXY` 설정 상태에서 프록시 "사용 안함" 설정
   - 모델 목록 조회 성공 확인
   - 환경 변수 무시 확인

2. **프록시 에러 처리 테스트**:
   - 잘못된 프록시 설정으로 HTML 에러 페이지 수신
   - 명확한 에러 메시지 표시 확인
   - 응답 미리보기로 실제 에러 내용 확인 가능

## 🎉 결론

v0.6.15는 **프록시 환경 안정성의 완성판**입니다:

- ✅ 프록시 비활성화 설정이 환경 변수에 영향받지 않음
- ✅ 프록시 에러 발생 시 명확한 원인 파악 가능
- ✅ 기업 프록시 환경에서도 안정적인 동작
- ✅ 사용자 친화적인 에러 메시지

---

**전체 변경사항**: [v0.6.14...v0.6.15](https://github.com/jhl-labs/sepilot_desktop/compare/v0.6.14...v0.6.15)
