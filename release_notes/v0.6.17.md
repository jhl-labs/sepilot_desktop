# SEPilot Desktop v0.6.17 릴리즈 노트

**릴리즈 날짜**: 2025-01-15

## 🎯 주요 개선사항

### undici 기반 프록시 환경 변수 무시 메커니즘 강화

v0.6.16에서 프록시 비활성화 시 환경 변수를 무시하도록 개선했지만, Node.js v18+의 기본 `fetch`가 undici를 사용하면서 환경 변수를 캐싱하는 문제가 발견되었습니다. 이번 릴리즈에서는 undici를 직접 사용하여 이 문제를 완전히 해결했습니다.

## 🐛 버그 수정

### 1. undici를 사용한 프록시 환경 변수 무시 메커니즘 강화

**문제**:

- Node.js v18+의 기본 `fetch`는 undici 기반
- undici는 프로세스 시작 시 `HTTPS_PROXY`, `HTTP_PROXY` 환경 변수를 캐싱
- 런타임에 환경 변수를 삭제해도 캐싱된 값이 사용됨
- `https.Agent`를 전달해도 undici는 `dispatcher` 옵션만 인식
- 결과: 프록시 비활성화 설정(`enabled: false, mode: 'none'`)이 있어도 환경 변수의 프록시가 사용됨

**수정 내역**:

**package.json**:

- `undici` 패키지 추가 (^7.16.0)

**lib/http/agent-factory.ts** (createNoProxyAgent 함수):

```typescript
// 기존: https.Agent 사용 (환경 변수 무시 불가)
const https = await import('node:https');
return new https.Agent(agentOptions);

// 변경: undici.Agent 사용 (환경 변수 완전 무시)
const { Agent } = await import('undici');
return new Agent({
  connect: {
    rejectUnauthorized: agentOptions.rejectUnauthorized !== false,
  },
});
```

**lib/http/fetch.ts**:

```typescript
// 기존: agent 옵션 사용 (undici에서 무시됨)
(fetchOptions as any).agent = agent;

// 변경: dispatcher 옵션 사용 (undici가 인식)
(fetchOptions as any).dispatcher = agent;
```

**효과**:

- ✅ 프록시 비활성화 시 환경 변수 완전 무시
- ✅ undici의 환경 변수 캐싱 우회
- ✅ `enabled: false, mode: 'none'` 설정이 확실하게 적용됨
- ✅ 이중 방어 메커니즘 강화:
  1. **Agent 레벨**: undici.Agent로 환경 변수 무시
  2. **Fetch 레벨**: 환경 변수 임시 제거 (기존 메커니즘 유지)

## 🔍 기술 세부사항

### Node.js fetch와 undici

Node.js v18+부터 기본 `fetch`는 undici를 사용합니다:

1. **환경 변수 캐싱**: undici는 프로세스 시작 시 환경 변수를 읽고 캐싱
2. **dispatcher 옵션**: `agent` 대신 `dispatcher` 옵션으로 agent 전달
3. **ProxyAgent**: undici.Agent를 사용하여 프록시 설정 제어

### 변경 전후 비교

#### 변경 전

```javascript
// 환경 변수 캐싱으로 인해 실패
HTTPS_PROXY=http://proxy:8080 node app.js
→ 프록시 비활성화 설정해도 환경 변수의 프록시 사용됨
```

#### 변경 후

```javascript
// undici.Agent로 환경 변수 완전 무시
HTTPS_PROXY=http://proxy:8080 node app.js
→ 프록시 비활성화 설정 시 환경 변수 무시됨
```

## 📊 적용 범위

### ✅ 완벽 적용된 기능

이번 릴리즈로 다음 기능들의 프록시 환경 안정성이 완벽해졌습니다:

- **LLM 통신**: OpenAI, Ollama (모델 조회, 채팅)
- **Settings UI**: 모든 연결 테스트 및 모델 조회
- **Embeddings**: 임베딩 모델 조회
- **GitHub 통합**: Release 정보 조회, OAuth 인증
- **모든 HTTP 통신**: 프록시 설정이 100% 정확하게 적용

### 프록시 설정 시나리오

#### 시나리오 1: 프록시 비활성화

```json
{ "proxy": { "enabled": false, "mode": "none" } }
```

- ✅ 환경 변수 HTTPS_PROXY **완전히** 무시 (undici 캐싱 우회)
- ✅ 프록시 없이 직접 연결

#### 시나리오 2: 시스템 프록시

```json
{ "proxy": { "enabled": true, "mode": "system" } }
```

- ✅ 환경 변수 (HTTPS_PROXY, HTTP_PROXY) 사용
- ✅ 자동 프록시 감지

#### 시나리오 3: 수동 프록시

```json
{ "proxy": { "enabled": true, "mode": "manual", "url": "http://proxy:8080" } }
```

- ✅ 지정된 프록시 URL 사용
- ✅ SSL 검증 설정 정확하게 적용

## 🔍 검증

### 정적 분석

- ✅ eslint: 통과
- ✅ TypeScript type-check: 통과
- ✅ Next.js build: 성공

### undici 적용 확인

로그에서 다음 메시지 확인:

```
[HTTP Agent] Creating undici no-proxy agent (ignores env vars)
```

이 메시지가 보이면 프록시 비활성화 시 undici.Agent가 올바르게 사용되고 있는 것입니다.

## 🎉 결론

v0.6.17은 **프록시 환경 변수 무시 메커니즘의 최종 완성판**입니다:

- ✅ undici 기반 환경 변수 캐싱 문제 해결
- ✅ dispatcher 옵션으로 agent 올바르게 전달
- ✅ 프록시 비활성화 설정이 환경 변수에 **절대** 영향받지 않음
- ✅ Node.js v18+의 기본 fetch와 완전 호환
- ✅ 기업 프록시 환경에서도 완벽한 동작
- ✅ 이중 방어 메커니즘으로 안정성 극대화

**v0.6.15 + v0.6.16 + v0.6.17 통합 개선사항**:

1. 프록시 비활성화 시 환경 변수 무시 처리 (이중 방어)
2. 프록시 환경에서 JSON 파싱 에러 감지 향상
3. UI에서 논리적 모순 방지
4. 자동 설정 정규화
5. 빌드 안정성 향상
6. **undici 기반 환경 변수 캐싱 우회** ← 이번 릴리즈

---

**전체 변경사항**: [v0.6.16...v0.6.17](https://github.com/jhl-labs/sepilot_desktop/compare/v0.6.16...v0.6.17)
