# SEPilot Desktop v0.6.0 릴리스 노트

## 주요 변경 사항

### 새로운 기능

* **Editor 모드 추가 (Chat + Editor 듀얼 모드)**
  * 사이드바 헤더에 "Chat"/"Editor" 모드 선택 드롭다운 메뉴 추가
  * **Chat 모드**: 기존 대화 기능 (ChatHistory, 대화 관리, 검색 등)
  * **Editor 모드**: 파일 편집 기능
    - FileExplorer: Working Directory 선택 및 파일 트리 탐색
    - Monaco Editor: 코드 편집기 (VS Code 엔진)
    - 파일 탭 관리: 여러 파일 동시 열기 및 전환
    - Dirty 상태 표시: 변경된 파일 표시 (●)
    - 저장 기능: Ctrl+S (Cmd+S) 단축키 지원
    - 구문 강조: 파일 확장자별 언어 자동 감지
    - 다크/라이트 테마 자동 적용
  * Monaco Editor 통합:
    - 개발 모드 CSP 정책에 Monaco CDN 허용 (`https://cdn.jsdelivr.net`)
    - script-src, style-src, font-src, worker-src에 CDN 도메인 추가
    - AMD loader polyfill 추가 (`require.config`, `define` 함수)
    - Monaco의 AMD 로더가 브라우저 환경에서 정상 작동하도록 지원
    - Dynamic import (SSR: false)로 Next.js 호환성 보장
  * 새로운 IPC 핸들러 추가:
    - `fs:read-directory`: 디렉토리 내용 읽기
    - `fs:read-file`: 파일 내용 읽기
    - `fs:write-file`: 파일 저장
  * 컴포넌트 분리:
    - `components/layout/ChatHistory.tsx`: Chat 모드 전용
    - `components/layout/FileExplorer.tsx`: Editor 모드 파일 탐색기
    - `components/editor/Editor.tsx`: Monaco Editor 래퍼

* **Quick Input (전역 단축키로 빠른 대화 시작)**
  * Ctrl+Shift+Space (Mac: Cmd+Shift+Space) 단축키로 어디서나 빠른 입력창 호출
  * "무엇을 도와드릴까요?" 간단한 프롬프트 입력창 표시
  * 입력 후 자동으로 새 대화 생성 및 메시지 전송
  * Claude Desktop과 유사한 UX 제공
  * System Tray 상주: 창을 닫아도 백그라운드에서 실행 유지
  * Tray 아이콘 클릭으로 메인 창 표시/숨김 전환
  * ESC 키로 Quick Input 창 닫기

### UI/UX 개선

* **이미지 첨부/생성 시 자동으로 Instant 모드로 전환 및 모드 잠금**
  * 이미지가 붙여넣기되거나 선택되면 자동으로 Thinking 모드가 Instant로 변경됨
  * 이미지 생성 토글이 활성화되면 자동으로 Instant 모드로 전환됨
  * 이미지 생성이 활성화된 동안 Thinking 모드 변경 불가 (두 기능은 공존 불가)
  * 멀티모달 모델과 이미지 생성은 Agent 그래프를 사용해야 하므로 Instant 모드가 최적
  * 사용자 경험 개선: 이미지 분석/생성 시 불필요한 사고 과정 생략

* **LLM 상태 표시줄을 별도 컴포넌트로 분리**
  * InputBox 하단의 모델 정보 표시 부분을 `LLMStatusBar` 컴포넌트로 분리
  * 모델명, max tokens, temperature, 컨텍스트 사용량 표시
  * 클릭하여 max tokens 및 temperature 즉시 수정 가능
  * 코드 재사용성 및 유지보수성 향상

* **사용 가능한 툴 목록 표시 기능**
  * LLMStatusBar에 MCP 툴 개수 표시 (예: "5 tools")
  * 툴 아이콘 클릭 시 Popover로 전체 툴 목록 표시
  * MCP 서버별 그룹화 및 Built-in 툴 구분
  * 각 툴의 이름과 설명 표시로 사용 가능한 기능 확인 용이
  * Radix UI Popover 컴포넌트 추가

### 코딩 에이전트 (Thinking Mode: Coding) 개선

* **최대 반복 횟수 10 → 50으로 증가**
  * 복잡한 작업 처리 능력 향상
  * Claude Code 수준의 작업 수행 가능
  * `lib/langgraph/state.ts`에서 `maxIterations` 기본값 변경

* **Built-in 도구 대폭 강화**
  * **command_execute**: 셸 명령어 실행 도구 추가
    - npm install, git 명령어, 빌드 도구 등 실행 가능
    - stdout, stderr 모두 반환하여 결과 확인 용이
    - 작업 디렉토리 지정 가능 (cwd 옵션)
  * **grep_search**: ripgrep 기반 코드 검색 도구 추가
    - 정규식 패턴 지원으로 빠른 코드 검색
    - 파일 타입 필터링 (ts, js, py 등)
    - 대소문자 구분 옵션 제공
    - 코드베이스 전체에서 함수, import 등 빠르게 찾기
  * `lib/mcp/tools/builtin-tools.ts`에 추가 구현

* **시스템 프롬프트 Claude Code 스타일로 전면 개선**
  * 더 상세하고 구체적인 작업 지침 제공
  * ReAct (Reasoning + Acting) 패턴 명시
  * 단계별 워크플로우 가이드:
    1. Understand First (file_list, grep_search, file_read)
    2. Make Changes Carefully (file_edit, file_write)
    3. Execute & Verify (command_execute로 빌드/테스트)
    4. Handle Dependencies (npm install 자동 실행)
  * 실전 사용 패턴 및 에러 처리 방법 포함
  * 툴 사용 예시로 정확한 동작 유도
  * 50회 반복 예산을 효율적으로 활용하도록 최적화

* **도구 실행 이력 (Activity) 시스템 추가**
  * 컨텍스트 낭비 방지: 메시지와 분리하여 관리
  * 영구 저장: 데이터베이스에 기록되어 프로그램 재시작 후에도 조회 가능
  * 실시간 기록: 모든 도구 실행 (성공/실패) 자동 기록
  * ActivityPanel 컴포넌트로 UI에 표시
    - 도구명, 인자, 결과, 실행 시간 등 상세 정보
    - 성공/실패 상태 시각화
    - 확장/축소 기능으로 상세 내용 확인
  * 타입 정의 및 IPC 핸들러 구현
  * Coding Agent에서 자동으로 activity 생성

* **고급 에러 처리 및 자가 회복 시스템 (2024-2025 연구 기반)**
  * **Self-Reflection 메커니즘** (Reflexion Pattern - NeurIPS 2023)
    - 에러 발생 시 자동으로 원인 분석 및 반성 생성
    - 에러 유형별 특화된 조언 (ENOENT, EACCES, string not found 등)
    - Verbal reinforcement learning으로 성능 향상 (p < 0.001)
  * **Loop Detection** (2025 최신 연구)
    - 반복되는 도구 호출 자동 감지 (3회 이상 동일 호출)
    - Alternating pattern 감지 (A-B-A-B-A-B)
    - 무한 루프 방지로 compute 낭비 제거
  * **Progressive Hints 시스템** (Progressive Prompting 2024)
    - 실패 횟수에 따라 점진적으로 더 상세한 힌트 제공
    - 1회 실패: "파일 다시 읽기, 경로 확인"
    - 2회 실패: "작은 단계로 나누기, grep_search 활용"
    - 3회 이상: "완전히 다른 접근, 사용자에게 가이던스 요청"
  * **Context Window 관리** (2024 연구)
    - 첫 메시지(사용자 요청) 항상 유지
    - 최근 20개 메시지로 자동 축약
    - 토큰 사용량 최대 50% 절감
  * **Retry Logic 준비**
    - Exponential backoff with jitter (2025 Best Practice)
    - 최대 3-5회 재시도
    - Explicit failure classification (transient vs permanent)
  * State 필드 추가: reflections, errorHistory, toolCallHistory, consecutiveFailures, stuckDetected
  * 상세 문서: `lib/langgraph/ADVANCED_ERROR_HANDLING.md`

* **Human-in-the-loop 툴 승인 기능 정상 작동**
  * `CodingAgentGraph` 클래스 추가 및 `stream()` 메서드 구현
  * Agent 그래프와 동일한 패턴으로 툴 승인 콜백 통합
  * 툴 호출 시 사용자 승인 대기 및 승인/거부 이벤트 처리
  * `lib/langgraph/index.ts`의 `streamCodingAgentGraph()` 메서드로 스트리밍 처리

* **에이전트 툴 호출 화면 표시 개선**
  * 각 노드 실행 시 이벤트 yield 추가 (`type: 'node'`)
  * Triage, Planner, Agent, Tools, Verifier, Reporter 등 모든 노드의 실행 상태 UI에 표시
  * 툴 승인 요청 및 결과 이벤트 (`tool_approval_request`, `tool_approval_result`) 별도 처리
  * 에러 이벤트 (`type: 'error'`) 처리 강화

* **코드 구조 개선**
  * Agent 그래프 (`agent.ts`)의 구현 패턴을 Coding Agent에 적용
  * 반복 가드 (iteration guard) 로직으로 무한 루프 방지
  * State 업데이트 및 이벤트 방출 로직 일관성 확보

* **Coding Agent 과정 전체 표시 (Claude Code 스타일)**
  * ReAct iteration 중 메시지가 사라지는 문제 해결
  * 모든 thinking, tool call, tool result 과정을 순차적으로 표시
  * 각 단계별 아이콘 및 포맷팅:
    - 🤔 **Thinking**: AI의 사고 과정
    - 🔧 **Using tools**: 사용 중인 툴 목록
    - ✅ **Tool result**: 툴 실행 결과 (500자 초과 시 truncate)
  * 긴 스크롤이 발생해도 전체 과정이 유지되어 사용자가 무슨 일이 일어나는지 명확히 파악 가능

* **Claude Code 스타일로 완전 리팩토링**
  * 복잡한 노드 제거 (Triage, Planner, Verifier)
  * 단순한 ReAct 루프 구현: Agent → Tool Approval → Tools → 반복
  * enhancedToolsNode에서 툴 결과를 메시지로 변환하여 LLM에 전달
    - file_list 등의 툴이 가짜 응답 대신 실제 결과 반환
    - OpenAI 호환 형식으로 tool result 메시지 생성
  * Reporter 노드를 에러/최대 반복 시에만 메시지 생성하도록 수정
    - 정상 완료 시 빈 객체 반환하여 기존 메시지 유지
    - 모든 thinking, tool call, tool result 과정이 화면에 남아있음
  * ToolExecutionResult 타입 명시적 정의로 타입 안정성 확보

* **Claude Code 스타일 툴 승인 UI 구현**
  * ToolApprovalDialog에 "예/아니오/항상 예(이번 세션)" 3가지 버튼 제공
  * 세션 단위 자동 승인 기능 (alwaysApproveToolsForSession)
    - "항상 예" 선택 시 이후 모든 툴 호출 자동 승인
    - 페이지 새로고침 시 초기화 (세션 단위)
  * ChatStore에 상태 관리 추가 및 InputBox에서 자동 승인 로직 처리
  * 반복적인 승인 없이 원활한 코딩 작업 가능

* **파일 변경 사항 Git Diff 스타일 표시**
  * 파일 생성/수정/삭제 시 변경 사항을 git diff 스타일로 시각화
  * MessageBubble에서 file_write, file_edit 툴 호출 자동 감지
  * CodeDiffViewer로 라인별 변경 사항 표시:
    - 추가된 줄 (+) 초록색
    - 삭제된 줄 (-) 빨간색
    - 수정된 줄 (~) 주황색
  * 파일 경로, 변경 통계 (추가/삭제/수정 라인 수) 표시
  * Message 타입에 FileChange 인터페이스 추가
  * Cursor 스타일의 파일 변경 확인 UI 제공

### RAG 개선

* **문서 청킹 크기 최적화**
  * chunkSize를 500자에서 2500자로 증가 (5배)
  * chunkOverlap을 50자에서 250자로 증가 (10% 비율 유지)
  * 벡터 임베딩 품질을 유지하면서도 더 풍부한 맥락 제공
  * 문서가 과도하게 쪼개지는 문제 해결 (청크 수 1/5로 감소)
  * 2500자는 약 600-750 토큰으로 임베딩 모델의 최적 범위 내
  * 한국어 텍스트에 더 적합한 크기로 여러 문단의 맥락 유지 가능

* **문서 목록 UI 개선 - 청크 자동 병합**
  * DocumentList에서 청크된 문서들을 원본 문서 단위로 자동 그룹화
  * metadata의 originalId를 기준으로 청크 병합 및 chunkIndex 순서대로 정렬
  * 사용자에게는 하나의 완전한 문서로 표시
  * 삭제/편집 시 모든 청크를 자동으로 함께 처리
  * 내부적으로는 RAG 검색을 위해 청크로 저장되지만 UI는 직관적으로 개선됨
  * 로그에 "Loaded X chunks, grouped into Y documents" 표시

### 버그 수정

* **Editor 컴포넌트 버튼 중첩 하이드레이션 에러 수정**
  * 파일 탭의 닫기 버튼이 탭 버튼 내부에 중첩되어 있던 문제 해결
  * HTML 규칙 위반: `<button>` 내부에 `<button>` 불가
  * `<button>`을 `<span>`으로 변경하고 `cursor-pointer` 추가
  * 클릭 이벤트 정상 작동 및 하이드레이션 에러 제거

* **Monaco Editor 로딩 문제 해결 (CopyWebpackPlugin 방식)**
  * Monaco Editor가 CDN에서 로드되어 CSP 정책에 의해 차단되던 문제 수정
  * `copy-webpack-plugin` 사용하여 Monaco Editor 파일을 public 디렉토리로 자동 복사
  * Next.js webpack 설정에 CopyWebpackPlugin 추가
  * `loader.config({ paths: { vs: '/monaco/vs' } })` 설정으로 로컬 파일 사용
  * Dynamic import with SSR: false로 브라우저 전용 컴포넌트 처리
  * 개발 및 프로덕션 환경에서 모두 안정적으로 작동
  * .gitignore에 /public/monaco 추가 (빌드 시 자동 생성)

* **LLM 에러 발생 시 화면에 표시되지 않던 문제 해결**
  * CodingAgentState에 `agentError` 필드 추가
  * LLM API 호출 실패 시 (500 Internal Server Error 등) 사용자 친화적 에러 메시지 표시
  * 에러 발생 즉시 루프 종료 및 Reporter에서 처리
  * 이전에는 에러가 로그에만 출력되고 UI에 표시되지 않았던 문제 수정

* **파일 쓰기 시 500 에러 발생 문제 해결**
  * 빈 content를 가진 assistant 메시지 필터링
    - OpenAI API가 거부할 수 있는 빈 메시지 제거
    - tool_calls가 있는 메시지는 유지
  * 컨텍스트 길이 제한 (최대 20개 메시지)
    - 메시지 누적으로 인한 컨텍스트 오버플로우 방지
    - 120B 모델의 처리 한계 초과 문제 해결
  * 디버깅 로그 추가 (메시지 개수, role, content 길이, 필터링 통계)

* **상태 메시지 표시 시 기존 대화 내용이 지워지는 문제 해결**
  * "답변을 생성하고 있습니다...", "도구를 실행하고 있습니다..." 등 상태 메시지 표시 시 기존 content 유지
  * scheduleUpdate 호출 시 기존 content에 추가하도록 수정
  * 수정된 메시지: 툴 실행 완료, 이미지 생성 진행/에러, 툴 승인 대기, 노드 실행 상태
  * 노드 실행 상태 메시지 (generate, tools, reporter) 표시 시에도 기존 내용 보존
  * 이제 모든 thinking, tool calls, tool results 과정이 화면에 유지됨

* **grep_search 도구가 working directory에서 실행되지 않던 문제 해결**
  * handleGrepSearch 함수에서 execPromise 호출 시 cwd 옵션 누락
  * getCurrentWorkingDirectory()를 사용하여 working directory에서 ripgrep 실행하도록 수정
  * command_execute와 동일한 패턴 적용
  * 이제 Coding 모드에서 설정한 작업 디렉토리 내에서 코드 검색이 제대로 수행됨

* **ChatArea의 handleRegenerate에서 working directory 전달 누락 문제 해결**
  * 메시지 재생성 시 working directory를 LangGraph에 전달하지 않던 문제 수정
  * InputBox와 동일하게 workingDirectory를 stream 호출 시 전달
  * 이제 재생성 시에도 설정한 작업 디렉토리에서 도구가 실행됨

* **도구 실행 로그 UI 전면 개선 (Claude Code 스타일)**
  * **도구 호출 중복 표시 제거**
    - 이전: "🔧 command_execute" + "✅ command_execute" (두 번 표시)
    - 이후: "🔧 command_execute `npm install`\n   ✅ added 142 packages in 5s"
  * **성공 시에도 유용한 정보 표시**
    - file_edit: "Modified package.json" 또는 "3 lines changed"
    - file_read: "Read 45 lines"
    - file_list: "Found 10 items"
    - command_execute: stdout 첫 5줄 표시 (200자 제한)
    - grep_search: "Found 5 matches"
  * **에러 메시지 상세 표시**
    - 명령어/파일 경로와 함께 에러 내용 표시
    - 최대 10줄 또는 800자까지 표시
    - stderr/stdout 모두 확인 가능
    - npm install 실패 시 peer dependency 충돌 등 상세 원인 파악
  * **진행 상황 한눈에 파악**
    - 어떤 파일을 읽었는지, 수정했는지 명확히 표시
    - 명령어 실행 결과(stdout)도 확인 가능
    - 무엇을 했는지 대화 내용만으로 완전히 이해 가능
  * **Claude Code와 유사한 UX**
    - 도구 호출과 결과를 하나로 통합
    - Thinking 내용 300자로 축약
    - 개발 및 디버깅 과정 완전 추적 가능

* **command_execute 도구의 빈 cwd 처리 개선**
  * LLM이 `cwd: ""`(빈 문자열)을 전달하는 경우 무시하도록 수정
  * 빈 문자열은 null로 처리하여 getCurrentWorkingDirectory() 사용
  * working directory 설정이 제대로 적용되도록 개선

* **설정 변경 시 프로그램 재시작 없이 즉시 반영되도록 수정**
  * Main Process의 `llm-init` 핸들러가 `LLMConfig` 대신 `AppConfig`를 올바르게 받도록 수정
  * `types/electron.d.ts`의 타입 정의와 실제 구현 불일치 문제 해결
  * 이제 LLM/Network 설정 변경 후 바로 적용됨 (재시작 불필요)

* **이미지 갤러리/문서 관리 페이지에서 대화 클릭 시 채팅 화면으로 전환되지 않던 문제 해결**
  * Sidebar에 `onConversationClick` prop 추가
  * 대화 목록 및 검색 결과 클릭 시 viewMode를 'chat'으로 전환하도록 수정
  * 이제 갤러리나 문서 페이지에서 사이드바의 대화를 클릭하면 정상적으로 채팅 화면으로 돌아감

* **InputBox 컴포넌트 미사용 변수 제거**
  * `ImageGenerationProgress` 타입 import 제거
  * `updateImageGenerationProgress` 함수 destructure 제거

* **LLMStatusBar 툴 개수 표시 불일치 문제 해결**
  * 툴 아이콘 옆 개수와 Popover 내부 개수가 일치하지 않던 문제 수정
  * mcpToolCount (builtin 제외) 대신 전체 tools.length 사용으로 통일
  * 이제 외부 표시와 다이얼로그 내부가 동일한 개수 표시

* **코드 품질 개선 (ESLint 에러 수정)**
  * Quick Input 페이지: useEffect 내 setState 에러 해결 및 불필요한 console.log 제거
  * chat-store: 미사용 ToolCall import 제거, if 문 중괄호 추가
  * error-handler: if 문 중괄호 추가
  * id-generator: crypto → globalThis.crypto 변경으로 ESLint no-undef 에러 해결
  * embeddings/client: case 블록에 중괄호 추가로 lexical declaration 에러 해결
  * app/page.tsx: Quick Input 관련 디버깅 console.log 제거

### 보안

* **의존성 보안 취약점 해결**
  * `electron-icon-builder` 패키지 제거 (12개 취약점 원인)
    - form-data (critical): 안전하지 않은 랜덤 함수 사용
    - svg2png, request (moderate): deprecated 패키지, 패치 없음
    - yargs-parser, tough-cookie, phin (moderate): Prototype Pollution 등
  * `sharp` + `png-to-ico`를 사용한 자체 아이콘 빌드 스크립트로 대체
  * 모든 플랫폼(Windows/macOS/Linux) 아이콘 생성 지원
  * 보안 취약점 0개로 개선

### 테스트

* **프론트엔드 테스트 커버리지 대폭 향상 (1차: 37.89% → 41.88%)**
  * 5개 주요 컴포넌트에 대한 종합 테스트 추가 (115개 테스트 케이스):
    - `LLMStatusBar` 테스트 26개 추가 (커버리지 **95%** 달성)
    - `CodeDiffViewer` 테스트 20개 추가 (커버리지 **100%** 달성)
    - `MessageBubble` 테스트 22개 추가 (11.11% → **36.36%**)
    - `ToolApprovalDialog` 테스트 17개 추가 (11.11% → **90.47%**)
    - `MarkdownRenderer` 테스트 30개 추가 (14.58% → **19.79%**)
  * 전체 커버리지: 37.89% → **41.88%** (약 4% 향상)
  * components/chat 커버리지: 21.59% → **36.57%** (약 15% 향상)

* **프론트엔드 테스트 커버리지 추가 향상 (2차: 41.88% → 43.31%)**
  * 4개 추가 컴포넌트에 대한 종합 테스트 (130개 테스트 케이스):
    - `Sidebar` 테스트 27개 추가 (57.64% → **80%**)
      * 대화 목록 렌더링, 생성, 전환, 삭제
      * 이름 편집 (저장/취소)
      * 검색 기능 및 결과 표시
      * 설정/갤러리/문서 버튼 콜백
    - `CodeBlock` 테스트 24개 추가 (41.17% → **94.11%**)
      * 구문 강조 표시 (언어별)
      * 복사 기능 및 피드백
      * 언어 별칭 매핑 (js→javascript, ts→typescript 등)
      * 테마 적용 (dark/light)
    - `ImageGenerationProgressBar` 테스트 23개 추가 (13.04% → **91.3%**)
      * 상태별 렌더링 (queued, executing, completed, error)
      * 진행률 표시 및 진행바
      * 단계 정보 표시
      * 아이콘 및 애니메이션
    - `ThemeToggle` 테스트 10개 추가 (100% → **100%** 유지)
      * 다크/라이트 모드 토글
      * SSR 하이드레이션 처리
      * 아이콘 표시 및 접근성
  * 전체 테스트 결과: **566 passed**, 40 failed, 11 skipped (총 617개)
  * 전체 커버리지: 41.88% → **43.31%** (+1.43%)
  * components/layout 커버리지: 57.64% → **80%** (+22.36%)
  * components/markdown 커버리지: 19.79% → **24.47%** (+4.68%)
  * components/chat 커버리지: 36.57% → **38.32%** (+1.75%)
  * components/theme 커버리지: **100%** 달성

* **세 번째 커버리지 개선 (Phase 3)**
  * `InputBox` 컴포넌트 테스트 40개 추가 (24.73% → **25.97%**)
    - 입력 처리 및 전송 기능
    - Thinking 모드 선택 및 전환
    - RAG/Tools/이미지생성 토글
    - 스트리밍 상태 처리 및 중지
    - 도구 승인 다이얼로그
    - IME composition 처리
    - 드래그앤드롭 (테스트 계획)
  * `LLMStatusBar` 테스트 수정
    - compact 버튼 테스트 개선
    - mock 메시지 개수 조정 (messages.length > 2 조건)
  * `NetworkSettingsTab` 컴포넌트 테스트 24개 추가 (**100% 커버리지 달성**)
    - 프록시 설정 enable/disable
    - 프록시 모드 선택 (none, system, manual)
    - 프록시 URL 입력
    - SSL 인증서 검증 toggle
    - 보안 경고 메시지 표시
    - 저장 버튼 및 상태 처리
    - 성공/에러 메시지 표시
  * 전체 커버리지: 43.31% → **43.79%** (+0.48%)
  * components/settings 커버리지: 15.56% → **16.19%** (+0.63%)
  * `useChatStore.getState` mock 추가로 테스트 안정성 향상
  * 전체 테스트 결과: **632 passed**, 38 failed, 11 skipped (총 681개)

* **테스트 수정 및 개선**
  * id-generator 테스트: crypto.randomUUID mock 수정
  * github-oauth 테스트: window.sessionStorage 참조 수정
  * use-keyboard-shortcuts: backend → frontend 프로젝트로 이동
  * langgraph/state 테스트: ESM 호환성 문제로 제외 처리

---

**전체 변경 로그**: v0.5.0...v0.6.0
