# SEPilot Desktop v0.5.0 릴리스 노트

## 주요 변경 사항

### LangGraph 기반 아키텍처

- LangGraph를 통한 LLM 워크플로 관리 도입
- 여러 가지 사고(Thinking) 모드 추가: Instant, Sequential, Tree-of-Thought, Deep
- Sequential Thinking 단계에 로딩 인디케이터 추가

### Human-in-the-loop (HITL) 도구 승인

- MCP 도구 실행 전에 사용자 승인 필요
- 도구 승인 대화상자 UI 추가
- 승인/거절 흐름이 포함된 5분 타임아웃

### 실시간 스트리밍 개선

- 모든 LLM Thinking 전략에 실시간 스트리밍 적용
- conversationId 기반 스트리밍 격리로 크로스 토크 방지
- RAF 기반 배칭으로 반응성 개선
- **Agent 그래프 스트리밍 지원 추가**
  - Tool calling과 스트리밍 동시 지원
  - OpenAI API tool_calls delta 누적 처리
  - LLMService.streamChatWithChunks() 메서드 추가
  - generateWithToolsNode를 스트리밍 방식으로 전환

### 복잡한 코딩 작업을 위한 ReAct Agent 추가

- **Coding Agent Graph 구현** (lib/langgraph/graphs/coding-agent.ts)
  - Python SEPilot CLI의 복잡한 ReAct 패턴을 TypeScript로 이식
  - 다단계 파이프라인: Triage → Planning → Iteration Guard → Agent → Approval → Tools → Verification → Reporter
  - 실행 계획 자동 생성 및 단계별 실행
  - 파일 변경사항 추적 (added, modified, deleted)
  - 반복 제어 및 무한 루프 방지
  - 실행 결과 자동 검증
  - 최종 요약 보고서 생성
- **CodingAgentState 정의**
  - Planning & Verification 상태 추적
  - File Tracking (requiredFiles, modifiedFiles, fileChangesCount)
  - Iteration Control (iterationCount, maxIterations, forceTermination)
  - Token & Cost Tracking
- **주요 기능**
  - Triage: 간단한 질문은 바로 응답, 복잡한 작업은 전체 파이프라인 실행
  - Planning: 작업 계획 생성 (READ-ONLY vs MODIFICATION 자동 분류)
  - Iteration Guard: 반복 횟수 제한으로 안전성 확보
  - Verification: 필수 파일 수정 여부 확인, 계획 단계 진행 체크
  - File Change Tracking: 도구 실행 전후 파일 스냅샷 비교로 변경사항 자동 감지
- **Built-in File Tools 추가**
  - MCP 서버 없이도 사용 가능한 내장 파일 처리 도구
  - file_read: 파일 내용 읽기
  - file_write: 파일 생성/덮어쓰기
  - file_edit: 기존 파일의 특정 부분 수정 (old_str → new_str 교체)
  - file_list: 디렉토리 파일 목록 조회
  - Main Process 시작 시 자동 등록 (lib/mcp/tools/builtin-tools.ts)
- **Cursor-style Code Diff Viewer**
  - 파일 수정 도구 사용 시 변경 전후 코드 비교 UI 제공
  - CodeDiffViewer 컴포넌트: 라인별 변경사항 시각화 (추가/삭제/수정)
  - ToolApprovalDialog에 통합: file_edit, file_write 도구 승인 시 자동 표시
  - 파일 경로, 변경 통계 (추가/삭제/수정 라인 수) 표시
  - 향후 react-diff-view 라이브러리 도입 예정 (side-by-side view, syntax highlighting)

### UI/UX 개선

- **Coding (beta) 사고 모드 추가**
  - InputBox에서 "Coding (beta)" 선택 옵션 추가
  - 복잡한 코딩 작업을 위한 ReAct Agent 자동 활성화
  - 선택 시 Tools 자동 활성화
  - Code 아이콘으로 시각적 구분
- **작업 디렉토리 표시 및 설정 기능**
  - Coding 모드에서만 표시되는 작업 디렉토리 인디케이터 추가
  - InputBox 위에 최소한의 공간으로 현재 작업 경로 표시 (레이아웃 유지)
  - 디렉토리 선택 다이얼로그로 작업 경로 변경 가능
  - 경로 클릭으로 디렉토리 재선택 가능
  - X 버튼으로 작업 디렉토리 제거 기능
  - 긴 경로는 마지막 2개 세그먼트만 표시 (hover 시 전체 경로 툴팁)
- **Coding Agent 도구 사용 개선**
  - LLM에게 파일 작업 시 반드시 도구를 사용하도록 지시하는 system prompt 추가
  - 도구 사용 예시 및 가이드라인 제공
  - 코드를 텍스트로만 보여주지 않고 실제로 파일을 생성/수정하도록 개선
- 채팅 영역 글꼴 크기 조절 기능 (50%~200%)
- 이미지 갤러리: 첨부 및 생성된 이미지 보기
- **향상된 이미지 생성 진행 표시**
  - 실시간 퍼센트 업데이트가 포함된 진행 바
  - 현재 단계와 전체 단계 표시
  - 대화 전환 시에도 진행 상태가 유지됨 (글로벌 상태 저장)
  - 대기(Queued), 실행(Executing), 완료(Completed), 오류(Error) 상태를 시각적으로 표시
  - 진행 바가 InputBox와 MessageBubble 모두에 표시
  - 이미지 생성 성공 시 자동으로 이미지 생성 토글 비활성화

- 설정(Settings) 다이얼로그가 여러 탭으로 재구성됨
- 툴팁 가독성 향상
- **MCP 서버 설정 개선**
  - 환경 변수 입력 UI 추가 (고급 옵션에서 설정 가능)
  - GitHub 서버 템플릿에 GITHUB_PERSONAL_ACCESS_TOKEN 환경 변수 추가
  - Brave Search 템플릿에 BRAVE_API_KEY 환경 변수 추가
  - Git 서버 템플릿에 --repository 인자 추가
  - Filesystem 및 SQLite 템플릿 경로를 크로스 플랫폼 호환으로 개선
  - 환경 변수 "키=값" 형식으로 여러 개 입력 가능

- **RAG 문서 업로더 대폭 개선**
  - 탭 구조로 3가지 입력 방식 지원: 텍스트 직접 입력 / URL에서 가져오기 / 파일 업로드
  - URL 가져오기: 웹 페이지를 자동으로 마크다운으로 변환
  - 파일 업로드: TXT, MD, PDF, DOCX 형식 지원
  - LLM 문서 정제 기능: 핵심 내용만 추출하고 불필요한 내용 자동 제거
  - 업로드 전/후 문서 정제 옵션
  - 향상된 UI/UX (MCPServerConfig와 일관된 디자인)

### 자동 업데이트

- GitHub Release 기반 업데이트 확인
- 새로운 버전 알림 UI 추가

### 언어 및 현지화

- LangGraph 사고 그래프(Sequential Thinking, Tree-of-Thought, Deep Thinking)의 시스템 프롬프트를 한국어로 변경
- 중간 사고 과정에서 영어로 응답하던 문제 해결
- 모든 프롬프트에 "반드시 한국어로 답변하세요" 지시 추가

### 버그 수정

- **Coding Agent에서 Built-in tools가 작동하지 않던 문제 해결**
  - toolsNode가 MCP tools만 조회하여 Built-in tools(file_read, file_write, file_edit, file_list)를 찾을 수 없던 버그 수정
  - Coding Agent Graph를 Built-in tools 전용으로 분리
  - agentNode에서 Built-in tools를 직접 LLM에 전달
  - enhancedToolsNode에서 Built-in tools를 직접 실행
  - 일반 Agent Graph는 MCP tools만 사용하도록 유지
  - "Tool 'file_write' not found" 에러 해결
- **Coding 모드 선택 시 일반 Agent Graph가 사용되던 문제 해결**
  - GraphFactory의 streamWithConfig에서 enableTools가 true이면 무조건 일반 Agent Graph를 사용하던 버그 수정
  - Coding 모드(thinkingMode === 'coding')일 때는 Coding Agent Graph를 사용하도록 조건문 수정
  - 이제 InputBox에서 "Coding (beta)" 선택 시 올바르게 Coding Agent Graph가 실행됨
- **Coding Agent의 중간 메시지들이 대화에 저장되지 않던 문제 해결**
  - Planning, Agent, Reporter 등 각 노드에서 생성한 메시지가 conversation에 저장되지 않던 버그 수정
  - InputBox에서 모든 노드의 assistant 메시지를 누적하여 저장하도록 개선
  - 이제 Coding Agent의 계획 수립, 실행 과정, 최종 보고서가 모두 대화 기록에 포함됨
  - 중복 방지 로직 추가로 같은 내용이 반복되지 않도록 처리
- **Built-in tools가 작업 디렉토리를 사용하지 않던 문제 해결**
  - WorkingDirectoryIndicator에서 설정한 작업 디렉토리가 Built-in tools에 전달되지 않던 버그 수정
  - streaming-callback에 currentWorkingDirectory 저장/조회 기능 추가
  - InputBox에서 LangGraph stream 시작 시 workingDirectory 전달
  - Built-in tools에서 상대 경로를 작업 디렉토리 기준 절대 경로로 변환
  - 이제 Coding 모드에서 지정한 디렉토리에 파일이 정상적으로 생성됨
- **새 파일 생성 시 CodeDiffViewer 에러 해결**
  - file:read IPC 핸들러에서 파일이 존재하지 않을 때 (ENOENT) 빈 문자열 반환하도록 수정
  - file_write로 새 파일 생성 시 diff 뷰어가 정상 작동
- Vision API 이미지 URL 형식 문제 수정
- Electron 환경에서 VectorDB 초기화 문제 해결
- 임베딩 모델 선택이 초기화되는 문제 수정
- Agent 모드에서 MCP 도구가 작동하지 않던 문제 해결
- RAG 문서 검색 오류 수정
- 설정 변경 사항이 앱 재시작 없이 즉시 적용되도록 개선
- **대화 제목 자동 생성 오류 수정**
  - IPC 핸들러(`llm-generate-title`)의 반환 형식이 프론트엔드 기대 형식과 불일치하여 "IPC title generation failed, using fallback" 오류 발생
  - 반환 형식을 `{ success: true, title: "..." }`에서 `{ success: true, data: { title: "..." } }`로 수정
  - 다른 LLM IPC 핸들러들과 일관된 형식으로 통일
- LLM 응답 중 대화를 전환할 때 스트리밍 메시지가 유실되던 문제 해결
  - background conversation 추적을 위한 messagesCache 추가
  - 스트리밍 중인 대화에서 벗어나도 메시지가 메모리에 유지되도록 개선

- 이미지 생성 도구(generate_image)가 작동하지 않던 문제 해결
  - **문제 1**: Renderer 프로세스에서만 `isComfyUIEnabled()`가 작동해 LLM에 도구가 전달되지 않음
  - **문제 2**: "ComfyUI가 구성되지 않음" 오류 — Main 프로세스에서 `ComfyUIClient` 싱글톤 사용 불가
  - **문제 3**: 이미지가 포함된 경우 Vision 모델이 사용되면서 도구 호출이 불가능해지는 문제
  - **문제 4**: 이미지 생성 후 Agent 루프가 계속되어 ComfyUI에 수백 개의 중복 요청이 발생하는 문제
  - **해결**: Main 프로세스 전체 이미지 생성 파이프라인 구현
    - GraphConfig를 통해 `enableImageGeneration` 전달
    - InputBox에서 Main 프로세스로 IPC를 통해 `ComfyUIConfig` 및 `NetworkConfig` 전달
    - Main 프로세스(tools.ts)에서 직접 ComfyUI HTTP/WebSocket 호출 구현
    - Node.js용 WebSocket 지원을 위해 `ws` 패키지 추가
    - streaming-callback에 `setCurrentComfyUIConfig()` / `setCurrentNetworkConfig()` 추가
    - 도구가 제공된 경우 Vision 모델 사용을 건너뛰도록 처리 (Vision 모델은 도구 호출 미지원)
    - 이미지 생성 성공 후 즉시 Agent 루프 종료
    - Agent 루프 최대 반복 횟수 감소 (50 → 10)로 안전성 강화

### 개발 환경 개선

- **ESLint v9 마이그레이션**
  - ESLint v9의 flat config (eslint.config.js) 형식으로 전환
  - 구형 `.eslintrc.json` 및 `.eslintignore` 파일 제거
  - `@eslint/eslintrc` 패키지 추가로 FlatCompat 지원
  - TypeScript, React, Next.js 플러그인 설정을 flat config 형식으로 재구성
  - 브라우저 및 Node.js 전역 객체 명시적 정의로 `no-undef` 오류 해결
  - electron, tests, scripts, public 폴더를 lint 검사 대상에서 제외
  - package.json의 lint 스크립트를 `next lint`에서 `eslint .`로 변경

---

**전체 변경 로그**: v0.2.5...v0.5.0
